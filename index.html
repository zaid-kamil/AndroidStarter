<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Androidstarter by RoRoche</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Androidstarter</h1>
      <h2 class="project-tagline">A sample Android app using the MVP architecture.</h2>
      <a href="https://github.com/RoRoche/AndroidStarter" class="btn">View on GitHub</a>
      <a href="https://github.com/RoRoche/AndroidStarter/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/RoRoche/AndroidStarter/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="little-stories-about-an-android-application-architecture" class="anchor" href="#little-stories-about-an-android-application-architecture" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Little stories about an Android application architecture</h1>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_android.png" alt="Android logo"></p>

<p>By writing this paper, my goal is to describe how I came up with the iOS app architecture I suggest.
It's a step by step writing to follow the reasons bringing me to set up the different components I chose.</p>

<p>The aim of the template application is very simple: it's a master/detail application to present a list of GitHub repositories of a given user.
Although it's simple, it gathers some classical jobs when writing an application:</p>

<ul>
<li>consume a REST API</li>
<li>save data to a local storage</li>
<li>load data from this local storage</li>
<li>architecture the logical layer and navigation between screens</li>
</ul>

<p>Let's discover what's hiding under the hood!</p>

<hr>

<h2>
<a id="consuming-rest-api" class="anchor" href="#consuming-rest-api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Consuming REST API</h2>

<h3>
<a id="rest-client" class="anchor" href="#rest-client" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST Client</h3>

<p><a href="http://square.github.io/retrofit/">Retrofit</a> is a well-known library that comes back frequently when developers list a "must-have libraries" for Android development.</p>

<p>I'm going to explain why I consider it's a must-have library:</p>

<ul>
<li>it's type-safe</li>
<li>the interface to write is human-readable, and annotation with path inside provide a useful mirror of the API</li>
<li>it provides a complete abstraction layer of how it works under the hood</li>
<li>it supports multipart request body (useful when you want to upload a file)</li>
<li>header management directly inside the interface using annotations</li>
<li>ability to use several serialization types (JSON, XML, protobuf, etc.) thanks to converters</li>
<li>possibility to add a global request interceptor (to set an authentication header with complex computation for each request for example)</li>
<li>it is easy to mock when testing</li>
</ul>

<p>It simple to add to a project via the following instruction in the <code>build.gradle</code> file:</p>

<div class="highlight highlight-source-groovy"><pre>    compile <span class="pl-s"><span class="pl-pds">'</span>com.squareup.retrofit:retrofit:2.0.0-beta2<span class="pl-pds">'</span></span></pre></div>

<p>Then I can declare an interface called <code>GitHubService</code> that mirrors the API and declares the method we need to use this one:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">GitHubService</span> {
    <span class="pl-k">@GET</span>(<span class="pl-s"><span class="pl-pds">"</span>/users/{user}/repos<span class="pl-pds">"</span></span>)
    <span class="pl-k">Call&lt;<span class="pl-k">List&lt;<span class="pl-smi">DTORepo</span>&gt;</span>&gt;</span> <span class="pl-en">listRepos</span>(<span class="pl-k">@Path</span>(<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>) <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">psUser</span>);
}</pre></div>

<p>Next I obtain an implementation of this interface via the <code>RestAdapter</code> class, as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">final</span> <span class="pl-smi">Retrofit</span> loRetrofit <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Retrofit</span>.<span class="pl-smi">Builder</span>()
    .baseUrl(<span class="pl-s"><span class="pl-pds">"</span>https://api.github.com<span class="pl-pds">"</span></span>)
    .addConverterFactory(<span class="pl-smi">JacksonConverterFactory</span><span class="pl-k">.</span>create())
    .build();

<span class="pl-k">final</span> <span class="pl-smi">GitHubService</span> loService <span class="pl-k">=</span> loRetrofit<span class="pl-k">.</span>create(<span class="pl-smi">GitHubService</span><span class="pl-k">.</span>class);
<span class="pl-k">return</span> loService;</pre></div>

<p>Another library I like to use is <a href="https://github.com/novoda/merlin">Merlin</a>. I see it as an utility tool to be aware of network connectivity state and changes. It provides a fluent API, simple to set up inside an Android project.</p>

<p>Personally, to get network connectivity state, I use its <code>MerlinsBeard</code> class that I can initialize like:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">final</span> <span class="pl-smi">MerlinsBeard</span> merlinsBeard <span class="pl-k">=</span> <span class="pl-smi">MerlinsBeard</span><span class="pl-k">.</span>from(context);</pre></div>

<p>And the a simple call to:</p>

<div class="highlight highlight-source-java"><pre>merlinsBeard<span class="pl-k">.</span>isConnected()</pre></div>

<p>tells me if the network is reachable or not.</p>

<h3>
<a id="parsing-data" class="anchor" href="#parsing-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Parsing data</h3>

<p>So, now we have our data coming from our remote server. It's time to describe how to process in order to get our POJOs. A common format to data-interchange format used is JSON. No surprise at this point. And if your familiar to the Java world, no more surprise when I tell you I'm going to set up a JSON parser using <a href="https://github.com/FasterXML/jackson">Jackson</a>! Obviously, no need to explain that Jackson is still one the most popular libraries in this subject.</p>

<p>Nevertheless, I would like to add some criteria that make me love Jackson:
First, I'm very satisfied with its fluent annotation API. And it's pretty helpful to be able to get and store properties that are not declare through the <code>@JsonProperty</code> annotation. Actually, here is some code to illustrate my words:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Example</span> {

    <span class="pl-k">@JsonIgnore</span>
    <span class="pl-k">private</span> <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> additionalProperties <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span>();

    <span class="pl-k">@JsonAnyGetter</span>
    <span class="pl-k">public</span> <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">Object</span>&gt;</span> <span class="pl-en">getAdditionalProperties</span>() {
        <span class="pl-k">return</span> <span class="pl-v">this</span><span class="pl-k">.</span>additionalProperties;
    }

    <span class="pl-k">@JsonAnySetter</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setAdditionalProperty</span>(<span class="pl-smi">String</span> <span class="pl-v">name</span>, <span class="pl-smi">Object</span> <span class="pl-v">value</span>) {
        <span class="pl-v">this</span><span class="pl-k">.</span>additionalProperties<span class="pl-k">.</span>put(name, value);
    }
}</pre></div>

<p>But how useful could it be? </p>

<p>Just think of a unusual behavior: I get a <code>NullPointerException</code> (for example) while processing my data. </p>

<p>But why? Simply because the JSON key changed server-side.</p>

<p>But how could I see It if the API team did not let me know... A dive to the debugger and we can see that the <code>additionalProperties</code> contains our expected value, but with a different key. And here we are! No wasting time any longer to debug this point.</p>

<h4>
<a id="combination-with-retrofit" class="anchor" href="#combination-with-retrofit" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Combination with Retrofit</h4>

<p>Cleverly, a dedicated Retrofit converter is available on GitHub: <a href="https://github.com/square/retrofit/tree/master/retrofit-converters/jackson">https://github.com/square/retrofit/tree/master/retrofit-converters/jackson</a>.</p>

<p>We can simply add it to our <code>build.gradle</code> as follow:</p>

<div class="highlight highlight-source-groovy"><pre>compile <span class="pl-s"><span class="pl-pds">'</span>com.squareup.retrofit2:converter-jackson:{{last_version}}<span class="pl-pds">'</span></span></pre></div>

<p>After that, we simply need to set it to our previous <code>RestAdapter</code>:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">final</span> <span class="pl-smi">Retrofit</span> loRetrofit <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Retrofit</span>.<span class="pl-smi">Builder</span>()
    .baseUrl(<span class="pl-s"><span class="pl-pds">"</span>https://api.github.com<span class="pl-pds">"</span></span>)
    .addConverterFactory(<span class="pl-smi">JacksonConverterFactory</span><span class="pl-k">.</span>create()) <span class="pl-c">// add the Jackson specific converter</span>
    .build();

<span class="pl-k">final</span> <span class="pl-smi">GitHubService</span> loService <span class="pl-k">=</span> loRetrofit<span class="pl-k">.</span>create(<span class="pl-smi">GitHubService</span><span class="pl-k">.</span>class);
<span class="pl-k">return</span> loService;</pre></div>

<h4>
<a id="bonus" class="anchor" href="#bonus" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Bonus</h4>

<p>I frequently use the online tool named <a href="http://www.jsonschema2pojo.org/"><em>jsonschema2pojo</em></a>. According to its description, it allows developers to</p>

<blockquote>
<p>Generate Plain Old Java Objects from JSON or JSON-Schema.</p>
</blockquote>

<p>To use it, we just have to paste a code snippet from the API, check the <em>JSON</em> radio of the <em>Source type</em> section. Using Jackson, I select the <em>Jackson 2.x</em> radio under the <em>Annotation style</em> section. Clicking on the <em>Preview</em> button gives me a Java class representing the JSON mapping I need. It cleverly speeds up my development!</p>

<h4>
<a id="an-attractive-alternative-moshi" class="anchor" href="#an-attractive-alternative-moshi" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>An attractive alternative: Moshi</h4>

<p>We can also adopt the emerging library provided by Square: <a href="https://github.com/square/moshi">Moshi</a>.</p>

<p>They also provide the corresponding <a href="https://github.com/square/retrofit/tree/master/retrofit-converters/moshi">converter to configure Retrofit</a>.</p>

<h4>
<a id="another-attractive-alternative-logansquare" class="anchor" href="#another-attractive-alternative-logansquare" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Another attractive alternative: LoganSquare</h4>

<p>A powerful library is named <a href="https://github.com/bluelinelabs/LoganSquare">LoganSquare</a>.
It relies on compile-time annotation processing to generate parsing/serializing code.</p>

<p>We can find converters written to make it works in combination with Retrofit:</p>

<ul>
<li>
<a href="https://github.com/aurae/retrofit-logansquare">https://github.com/aurae/retrofit-logansquare</a> (officially referenced by the Retrofit's wiki pages)</li>
</ul>

<h2>
<a id="communication-between-components-and-passing-data" class="anchor" href="#communication-between-components-and-passing-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Communication between components and passing data</h2>

<p>A frequently asked question in Android ecosystem is:</p>

<ul>
<li>how can to make components communicate together, and optionally passing parameters?</li>
</ul>

<p>A common response is to set up an event bus.
<a href="http://android-arsenal.com/tag/32">A lot a libraries provide solution to this problem</a>, among which:</p>

<ul>
<li><a href="http://square.github.io/otto/">Otto</a></li>
<li><a href="http://greenrobot.github.io/EventBus/">EventBus</a></li>
<li><a href="https://github.com/beworker/tinybus">TinyBus</a></li>
</ul>

<p>They have various approaches and motivations. But the one I chose is Otto, because I find it easy to:</p>

<ul>
<li>create a new bus instance</li>
<li>register to this bus instance</li>
<li>publish an event on this bus</li>
</ul>

<p>Nothing revolutionary, isn't it?</p>

<p>The key point of my choice comes from the official documentation:</p>

<blockquote>
<p>To subscribe to an event, annotate a method with <code>@Subscribe</code>. The method should take only a single parameter, the type of which will be the event you wish to subscribe to.</p>
</blockquote>

<p>I like the fact that I simply have to set the good parameter to my subscribing method to perform a specific job for each event.</p>

<p>But, the real point under the hood is the event inheritance. Indeed, if I define an <code>AbstractEventQueryDidFinish</code> (and I do so!), and then, for each query, a dedicated termination event such as <code>EventQueryADidFinish</code> and <code>EventQueryBDidFinish</code> for example, I'm able to:</p>

<ul>
<li>define a method to be notified of a <code>EventQueryADidFinish</code> publication</li>
<li>define a method to be notified of a <code>EventQueryBDidFinish</code> publication</li>
<li>and, the more interesting for me, define a method to be notified of a <code>AbstractEventQueryDidFinish</code> publication </li>
</ul>

<p>Actually, it can be pretty useful to have a global interceptor that is notified when a query finished, no matters its strong type.</p>

<p>For example, if you maintain a list a pending queries in an object (a synchronization engine for example), you can register this one to be notified of every <code>AbstractEventQueryDidFinish</code>.
So it becomes possible to refresh your pending queries list every time a query finished, and optionally store its results (failure or success).</p>

<h3>
<a id="thread-management" class="anchor" href="#thread-management" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Thread management</h3>

<p>Otto provides an API to define on which thread we can receive callbacks.
Nevertheless, I defined my own bus subclass to ensure that the subscribers are notified on the main thread:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">BusMainThread</span> <span class="pl-k">extends</span> <span class="pl-e">Bus</span> {
    <span class="pl-c">//region Field</span>
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">Handler</span> handler <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Handler</span>(<span class="pl-smi">Looper</span><span class="pl-k">.</span>getMainLooper());
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Constructor</span>
    <span class="pl-k">public</span> <span class="pl-en">BusMainThread</span>(<span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">psName</span>) {
        <span class="pl-v">super</span>(psName);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Overridden method</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">post</span>(<span class="pl-k">final</span> <span class="pl-smi">Object</span> <span class="pl-v">event</span>) {
        <span class="pl-k">if</span> (<span class="pl-smi">Looper</span><span class="pl-k">.</span>myLooper() <span class="pl-k">==</span> <span class="pl-smi">Looper</span><span class="pl-k">.</span>getMainLooper()) {
            <span class="pl-v">super</span><span class="pl-k">.</span>post(event);
        } <span class="pl-k">else</span> {
            handler<span class="pl-k">.</span>post(() <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-smi">BusMainThread</span><span class="pl-k">.</span><span class="pl-v">super</span><span class="pl-k">.</span>post(event));
        }
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>Finally, to have a little more control on which events are published on the thread, I defined an abstract class:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">AbstractEvent</span> { }</pre></div>

<p>And then, to provide a unified interface to communicate with the bus instances, I defined the following facade:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-k">class</span> <span class="pl-en">BusManager</span> {

    <span class="pl-c">//region Inner synthesize job</span>
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">Bus</span> sBusAnyThread <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Bus</span>(<span class="pl-smi">ThreadEnforcer</span><span class="pl-c1"><span class="pl-k">.</span>ANY</span>, <span class="pl-s"><span class="pl-pds">"</span>ANY_THREAD<span class="pl-pds">"</span></span>);
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">BusMainThread</span> sBusMainThread <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">BusMainThread</span>(<span class="pl-s"><span class="pl-pds">"</span>MAIN_THREAD<span class="pl-pds">"</span></span>);
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Specific any thread job</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">registerSubscriberToBusAnyThread</span>(<span class="pl-k">final</span> <span class="pl-smi">Object</span> <span class="pl-v">poSubscriber</span>) {
        <span class="pl-k">if</span> (poSubscriber <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            sBusAnyThread<span class="pl-k">.</span>register(poSubscriber);
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">unregisterSubscriberFromBusAnyThread</span>(<span class="pl-k">final</span> <span class="pl-smi">Object</span> <span class="pl-v">poSubscriber</span>) {
        <span class="pl-k">if</span> (poSubscriber <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            sBusAnyThread<span class="pl-k">.</span>unregister(poSubscriber);
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">postEventOnAnyThread</span>(<span class="pl-k">final</span> <span class="pl-smi">AbstractEvent</span> <span class="pl-v">poEvent</span>) {
        <span class="pl-k">if</span> (poEvent <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            sBusAnyThread<span class="pl-k">.</span>post(poEvent);
        }
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Specific main thread job</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">registerSubscriberToBusMainThread</span>(<span class="pl-k">final</span> <span class="pl-smi">Object</span> <span class="pl-v">poSubscriber</span>) {
        <span class="pl-k">if</span> (poSubscriber <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            sBusMainThread<span class="pl-k">.</span>register(poSubscriber);
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">unregisterSubscriberFromBusMainThread</span>(<span class="pl-k">final</span> <span class="pl-smi">Object</span> <span class="pl-v">poSubscriber</span>) {
        <span class="pl-k">if</span> (poSubscriber <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            sBusMainThread<span class="pl-k">.</span>unregister(poSubscriber);
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">postEventOnMainThread</span>(<span class="pl-k">final</span> <span class="pl-smi">AbstractEvent</span> <span class="pl-v">poEvent</span>) {
        <span class="pl-k">if</span> (poEvent <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            sBusMainThread<span class="pl-k">.</span>post(poEvent);
        }
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<h2>
<a id="managing-jobs" class="anchor" href="#managing-jobs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Managing jobs</h2>

<p>Multithreading and concurrency are recurrent developers consideration. It comes in combination with one of the most important rule when developing an Android application: don't block the UI thread! It's kind of "words of wisdom" but it's important to keep it in mind permanently.</p>

<p>So, we can easily list some jobs that must not be done on the main thread:</p>

<ul>
<li>call to the remote API</li>
<li>database CRUD operation</li>
<li>read a local file</li>
<li>etc.</li>
</ul>

<p>Fortunately, many resources comes to rescue: classes from the official Android SDK, blog posts, libraries and so on.</p>

<p>But one of the most useful resource I met is the "Android REST client applications" session from Google I/O 2010 by Virgil Dobjanschi:</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=xHXn3Kg2IQE">https://www.youtube.com/watch?v=xHXn3Kg2IQE</a></li>
<li><a href="https://dl.google.com/googleio/2010/android-developing-RESTful-android-apps.pdf">https://dl.google.com/googleio/2010/android-developing-RESTful-android-apps.pdf</a></li>
</ul>

<p>And I totally joined to one of its advices that are:</p>

<ul>
<li>use <a href="http://developer.android.com/reference/android/app/Service.html"><code>Service</code></a> class from the Android SDK</li>
<li>set up a <code>ServiceHelper</code> class to facade the call to network requests</li>
<li>have dedicated classes to process queries results (called <code>Processor</code> in this session)</li>
</ul>

<p>To explain why the use of a <code>Service</code>, I'd just like to quote the official documentation:</p>

<blockquote>
<p>A Service is an application component representing either an application's desire to perform a longer-running operation while not interacting with the user</p>
</blockquote>

<p>For me, it's typically the meaning of the component that should perform my network requests. But we have to note that services</p>

<blockquote>
<p>run in the main thread of their hosting process</p>
</blockquote>

<p>So we still have to manage multithreading by ourselves. So we need a specific layer to perform queries asynchronously.</p>

<p>Yes, I know, Retrofit provides a mechanism to achieve this point. But I looked for a more generic layer, able to perform any job that needs to be done in background.</p>

<p>At this point, I discovered <a href="https://github.com/yigit/android-priority-jobqueue">Android Priority Job Queue (Job Manager)</a>.</p>

<h3>
<a id="android-priority-job-queue-job-manager" class="anchor" href="#android-priority-job-queue-job-manager" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Android Priority Job Queue (Job Manager)</h3>

<p>It's probably one of the most documented, unit testing, powerful and reliable library I met. And it's based on the Google I/O brought up previously.</p>

<p>To set it up, we need to follow two steps.</p>

<h4>
<a id="job-manager-configuration" class="anchor" href="#job-manager-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Job Manager Configuration</h4>

<p>The <code>JobManager</code> is a key concept from this library. It's responsible of enqueuing and performing jobs. It's designed to be as flexible as possible to allow developer to make his own configuration.</p>

<p>It become possible to tell:</p>

<ul>
<li>how many threads can consume jobs at the same time</li>
<li>how to persist jobs that can not be performed at the moment</li>
<li>how to retrieve network connectivity status</li>
<li>which logger to use</li>
</ul>

<p>You can find more information at the following address: <a href="https://github.com/yigit/android-priority-jobqueue/wiki/Job-Manager-Configuration">https://github.com/yigit/android-priority-jobqueue/wiki/Job-Manager-Configuration</a></p>

<p>As a sample, here is the configuration I use to perform network requests:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">final</span> <span class="pl-smi">Configuration</span> loConfiguration <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Configuration</span>.<span class="pl-smi">Builder</span>(poContext)
    .minConsumerCount(<span class="pl-c1">1</span>) <span class="pl-c">//always keep at least one consumer alive</span>
    .maxConsumerCount(<span class="pl-c1">3</span>) <span class="pl-c">//up to 3 consumers at a time</span>
    .loadFactor(<span class="pl-c1">3</span>) <span class="pl-c">//3 jobs per consumer</span>
    .consumerKeepAlive(<span class="pl-c1">120</span>) <span class="pl-c">//wait 2 minute</span>
    .build();

<span class="pl-k">final</span> <span class="pl-smi">JobManager</span> loJobManager <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JobManager</span>(poContext, loConfiguration);</pre></div>

<h4>
<a id="job-configuration" class="anchor" href="#job-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Job Configuration</h4>

<p>A way I love with this library is to consider each network request as a specific <code>Job</code>. This is that abstract class we must extend if we want to configure a job. Thanks its constructor, it's highly-configurable. We can set some useful parameters to a job, as follow:</p>

<ul>
<li>its priority</li>
<li>if it requires network to be performed</li>
<li>if it should persists if it can not be performed</li>
<li>if it should run after some delay</li>
<li>its retry policy</li>
</ul>

<p>It's also possible de group jobs so that they can be sequential. It's pretty useful if you want to design a messaging client for example.</p>

<p>All necessary information about job configuration can be found on this page: <a href="https://github.com/yigit/android-priority-jobqueue/wiki/Job-Configuration">https://github.com/yigit/android-priority-jobqueue/wiki/Job-Configuration</a></p>

<p>The persistence engine of this library is very powerful. For example, if network is unreachable, jobs are serialized and persist on the device. Once the network become reachable, the <code>JobManager</code> dequeues the persisted jobs and perform them as usual.</p>

<p>I identified some redundant code when writing jobs to perform network requests. That's why I wrote an abstract class every query should extend:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">AbstractQuery</span> <span class="pl-k">extends</span> <span class="pl-e">Job</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">TAG</span> <span class="pl-k">=</span> <span class="pl-smi">AbstractQuery</span><span class="pl-k">.</span>class<span class="pl-k">.</span>getSimpleName();
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-c1">DEBUG</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>;

    <span class="pl-k">protected</span> <span class="pl-k">enum</span> <span class="pl-en">Priority</span> {
        <span class="pl-c1">LOW</span>(<span class="pl-c1">0</span>),
        <span class="pl-c1">MEDIUM</span>(<span class="pl-c1">500</span>),
        <span class="pl-c1">HIGH</span>(<span class="pl-c1">1000</span>);
        <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-k">int</span> value;

        <span class="pl-en">Priority</span>(<span class="pl-k">final</span> <span class="pl-k">int</span> <span class="pl-v">piValue</span>) {
            value <span class="pl-k">=</span> piValue;
        }
    }

    <span class="pl-k">protected</span> <span class="pl-k">boolean</span> mSuccess;
    <span class="pl-k">protected</span> <span class="pl-smi">Throwable</span> mThrowable;
    <span class="pl-k">protected</span> <span class="pl-smi">AbstractEventQueryDidFinish</span><span class="pl-k">.</span><span class="pl-smi">ErrorType</span> mErrorType;

    <span class="pl-c">//region Protected constructor</span>
    <span class="pl-k">protected</span> <span class="pl-en">AbstractQuery</span>(<span class="pl-k">final</span> <span class="pl-smi">Priority</span> <span class="pl-v">poPriority</span>) {
        <span class="pl-v">super</span>(<span class="pl-k">new</span> <span class="pl-smi">Params</span>(poPriority<span class="pl-k">.</span>value)<span class="pl-k">.</span>requireNetwork());
    }

    <span class="pl-k">protected</span> <span class="pl-en">AbstractQuery</span>(<span class="pl-k">final</span> <span class="pl-smi">Priority</span> <span class="pl-v">poPriority</span>, <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbPersistent</span>, <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">psGroupId</span>, <span class="pl-k">final</span> <span class="pl-k">long</span> <span class="pl-v">plDelayMs</span>) {
        <span class="pl-v">super</span>(<span class="pl-k">new</span> <span class="pl-smi">Params</span>(poPriority<span class="pl-k">.</span>value)<span class="pl-k">.</span>requireNetwork()<span class="pl-k">.</span>setPersistent(pbPersistent)<span class="pl-k">.</span>setGroupId(psGroupId)<span class="pl-k">.</span>setDelayMs(plDelayMs));
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Overridden methods</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onAdded</span>() {
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onRun</span>() <span class="pl-k">throws</span> <span class="pl-smi">Throwable</span> {
        <span class="pl-k">try</span> {
            execute();
            mSuccess <span class="pl-k">=</span> <span class="pl-c1">true</span>;
        } <span class="pl-k">catch</span> (<span class="pl-smi">Throwable</span> loThrowable) {
            <span class="pl-k">if</span> (<span class="pl-smi">BuildConfig</span><span class="pl-c1"><span class="pl-k">.</span>DEBUG</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">DEBUG</span>) {
                <span class="pl-smi">Logger</span><span class="pl-k">.</span>t(<span class="pl-c1">TAG</span>)<span class="pl-k">.</span>e(loThrowable, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
            }
            mErrorType <span class="pl-k">=</span> <span class="pl-smi">AbstractEventQueryDidFinish</span><span class="pl-k">.</span><span class="pl-smi">ErrorType</span><span class="pl-c1"><span class="pl-k">.</span>UNKNOWN</span>;
            mThrowable <span class="pl-k">=</span> loThrowable;
            mSuccess <span class="pl-k">=</span> <span class="pl-c1">false</span>;
        }

        postEventQueryFinished();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onCancel</span>() {
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getRetryLimit</span>() {
        <span class="pl-k">return</span> <span class="pl-c1">1</span>;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Protected abstract method for specific job</span>
    <span class="pl-k">protected</span> <span class="pl-k">abstract</span> <span class="pl-k">void</span> <span class="pl-en">execute</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span>;

    <span class="pl-k">protected</span> <span class="pl-k">abstract</span> <span class="pl-k">void</span> <span class="pl-en">postEventQueryFinished</span>();

    <span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">void</span> <span class="pl-en">postEventQueryFinishedNoNetwork</span>();
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>It defines:</p>

<ul>
<li>an <code>enum</code> describing available priorities I need</li>
<li>two constructor to provide both a simple and a complex way to build the query</li>
<li>the way to perform the specific code and how the exceptions are handled</li>
<li>a default retry limit</li>
</ul>

<p>We can see that there are three methods to implement:</p>

<ul>
<li>
<code>execute</code>: the specific code to perform</li>
<li>
<code>postEventQueryFinished</code>: the way to notify observers of the job termination (success or failure)</li>
<li>
<code>postEventQueryFinishedNoNetwork</code>: the way to notify observers of the job termination because the network is unreachable</li>
</ul>

<p>The two last methods are often based on the bus concept I talked previously.
Considering I'm using Otto to communicate between components, here comes the abstract event I defined:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">AbstractEventQueryDidFinish</span>&lt;QueryType <span class="pl-k">extends</span> <span class="pl-e">AbstractQuery</span>&gt; extends <span class="pl-e">AbstractEvent</span> {
    <span class="pl-k">public</span> <span class="pl-k">enum</span> <span class="pl-en">ErrorType</span> {
        <span class="pl-c1">UNKNOWN</span>,
        <span class="pl-c1">NETWORK_UNREACHABLE</span>
    }

    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-smi">QueryType</span> query;

    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-k">boolean</span> success;
    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-smi">ErrorType</span> errorType;
    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-smi">Throwable</span> throwable;

    <span class="pl-k">public</span> <span class="pl-en">AbstractEventQueryDidFinish</span>(<span class="pl-k">final</span> <span class="pl-smi">QueryType</span> <span class="pl-v">poQuery</span>, <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbSuccess</span>, <span class="pl-k">final</span> <span class="pl-smi">ErrorType</span> <span class="pl-v">poErrorType</span>, <span class="pl-k">final</span> <span class="pl-smi">Throwable</span> <span class="pl-v">poThrowable</span>) {
        query <span class="pl-k">=</span> poQuery;
        success <span class="pl-k">=</span> pbSuccess;
        errorType <span class="pl-k">=</span> poErrorType;
        throwable <span class="pl-k">=</span> poThrowable;
    }
}</pre></div>

<p>It's designed to embed </p>

<ul>
<li>the query that just finished</li>
<li>the termination status</li>
<li>and optionally the type of error and <code>Throwable</code> objet that occurred</li>
</ul>

<p>Each query I defined could publish a specific event, subclassing <code>AbstractEventQueryDidFinish</code>, to notify about its termination with status.</p>

<p>Putting it all together, here is a code snippet of the query I define to get GitHub repositories of a given user:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">QueryGetRepos</span> <span class="pl-k">extends</span> <span class="pl-e">AbstractQuery</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">TAG</span> <span class="pl-k">=</span> <span class="pl-smi">QueryGetRepos</span><span class="pl-k">.</span>class<span class="pl-k">.</span>getSimpleName();
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-c1">DEBUG</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>;

    <span class="pl-c">//region Fields</span>
    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> user;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Constructor matching super</span>
    <span class="pl-k">protected</span> <span class="pl-en">QueryGetRepos</span>() {
        <span class="pl-v">super</span>(<span class="pl-smi">Priority</span><span class="pl-c1"><span class="pl-k">.</span>MEDIUM</span>);
        user <span class="pl-k">=</span> psUser;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Overridden method</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">@SneakyThrows</span>(<span class="pl-smi">SQLException</span><span class="pl-k">.</span>class)
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">execute</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-k">final</span> <span class="pl-smi">GitHubService</span> gitHubService <span class="pl-k">=</span> <span class="pl-c">// specific code to get GitHubService instance</span>

        <span class="pl-k">final</span> <span class="pl-k">Call&lt;<span class="pl-k">List&lt;<span class="pl-smi">DTORepo</span>&gt;</span>&gt;</span> loCall <span class="pl-k">=</span> gitHubService<span class="pl-k">.</span>listRepos(user);
        <span class="pl-k">final</span> <span class="pl-k">Response&lt;<span class="pl-k">List&lt;<span class="pl-smi">DTORepo</span>&gt;</span>&gt;</span> loExecute <span class="pl-k">=</span> loCall<span class="pl-k">.</span>execute();
        <span class="pl-k">final</span> <span class="pl-k">List&lt;<span class="pl-smi">DTORepo</span>&gt;</span> loBody <span class="pl-k">=</span> loExecute<span class="pl-k">.</span>body();

        <span class="pl-c">// TODO deal with list of DTORepo</span>
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">postEventQueryFinished</span>() {
        <span class="pl-k">final</span> <span class="pl-smi">EventQueryGetRepos</span> loEvent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">EventQueryGetRepos</span>(<span class="pl-v">this</span>, mSuccess, mErrorType, mThrowable);
        busManager<span class="pl-k">.</span>postEventOnMainThread(loEvent);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">postEventQueryFinishedNoNetwork</span>() {
        <span class="pl-k">final</span> <span class="pl-smi">EventQueryGetRepos</span> loEvent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">EventQueryGetRepos</span>(<span class="pl-v">this</span>, <span class="pl-c1">false</span>, <span class="pl-smi">AbstractEventQueryDidFinish</span><span class="pl-k">.</span><span class="pl-smi">ErrorType</span><span class="pl-c1"><span class="pl-k">.</span>NETWORK_UNREACHABLE</span>, <span class="pl-c1">null</span>);
        busManager<span class="pl-k">.</span>postEventOnMainThread(loEvent);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Dedicated EventQueryDidFinish</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">class</span> <span class="pl-en">EventQueryGetRepos</span> <span class="pl-k">extends</span> <span class="pl-e">AbstractEventQueryDidFinish&lt;<span class="pl-smi">QueryGetRepos</span>&gt;</span> {
        <span class="pl-k">public</span> <span class="pl-en">EventQueryGetRepos</span>(<span class="pl-k">final</span> <span class="pl-smi">QueryGetRepos</span> <span class="pl-v">poQuery</span>, <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbSuccess</span>, <span class="pl-k">final</span> <span class="pl-smi">ErrorType</span> <span class="pl-v">poErrorType</span>, <span class="pl-k">final</span> <span class="pl-smi">Throwable</span> <span class="pl-v">poThrowable</span>) {
            <span class="pl-v">super</span>(poQuery, pbSuccess, poErrorType, poThrowable);
        }
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>And now, with a simple proxy class I call <code>QueryFactory</code> (it's very closed to the <code>ServiceHelper</code> mentioned by Virgil Dobjanschi), I can start easily every query with a strong protocol ti conform to:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">QueryFactory</span> {
    <span class="pl-c">//region Build methods</span>
    <span class="pl-k">public</span> <span class="pl-smi">QueryGetRepos</span> <span class="pl-en">buildQueryGetRepos</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">psUser</span>) {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">QueryGetRepos</span>(psUser);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Start methods</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">startQuery</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>, <span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">AbstractQuery</span> <span class="pl-v">poQuery</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">Intent</span> loIntent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ServiceQueryExecutorIntentBuilder</span>(poQuery)<span class="pl-k">.</span>build(poContext);
        poContext<span class="pl-k">.</span>startService(loIntent);
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">startQueryGetRepos</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>, <span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">psUser</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">QueryGetRepos</span> loQuery <span class="pl-k">=</span> buildQueryGetRepos(psUser);
        startQuery(poContext, loQuery);
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>The service to handle the query is declared as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ServiceQueryExecutor</span> <span class="pl-k">extends</span> <span class="pl-e">IntentService</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">TAG</span> <span class="pl-k">=</span> <span class="pl-smi">ServiceQueryExecutor</span><span class="pl-k">.</span>class<span class="pl-k">.</span>getSimpleName();

    <span class="pl-c">//region Extra fields</span>
    <span class="pl-smi">AbstractQuery</span> query;
    <span class="pl-c">//endregion</span>

    <span class="pl-smi">MerlinsBeard</span> merlinsBeard;
    <span class="pl-smi">JobManager</span> jobManager;

    <span class="pl-c">//region Constructor matching super</span>

    <span class="pl-c">/**</span>
<span class="pl-c">     * Creates an IntentService.  Invoked by your subclass's constructor.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-en">ServiceQueryExecutor</span>() {
        <span class="pl-v">super</span>(<span class="pl-c1">TAG</span>);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Overridden methods</span>
    <span class="pl-k">@DebugLog</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onHandleIntent</span>(<span class="pl-k">final</span> <span class="pl-smi">Intent</span> <span class="pl-v">poIntent</span>) {
        <span class="pl-c">// TODO get AbstractQuery from Intent </span>
        <span class="pl-c">// TODO get MerlinsBeard and JobManager instances</span>

        <span class="pl-c">// If query requires network, and if network is unreachable, and if the query must not persist</span>
        <span class="pl-k">if</span> (query<span class="pl-k">.</span>requiresNetwork() <span class="pl-k">&amp;&amp;</span>
                <span class="pl-k">!</span>merlinsBeard<span class="pl-k">.</span>isConnected() <span class="pl-k">&amp;&amp;</span>
                <span class="pl-k">!</span>query<span class="pl-k">.</span>isPersistent()) {
            <span class="pl-c">// then, we post an event to notify the job could not be done because of network connectivity</span>
            query<span class="pl-k">.</span>postEventQueryFinishedNoNetwork();
        } <span class="pl-k">else</span> {
            <span class="pl-c">// otherwise, we can add the job</span>
            jobManager<span class="pl-k">.</span>addJobInBackground(query);
        }
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>And here we have a consistent structure to manage network queries in a proper way that follows the guidelines from the Google I/O 2010.</p>

<h3>
<a id="rxjava" class="anchor" href="#rxjava" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RxJava</h3>

<p>Another approach is to adopt <a href="https://github.com/ReactiveX/RxJava">RxJava</a>. It allows developer to build asynchronous programs with an event-based mechanism using <code>Observable</code>.</p>

<p>ReactiveX provides <a href="https://github.com/ReactiveX/RxAndroid">Android specific bindings</a>.</p>

<p>It can be pretty useful. We will see how I use it to do CRUD operations on the database.</p>

<h2>
<a id="data-persistence" class="anchor" href="#data-persistence" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Data persistence</h2>

<h3>
<a id="the-orm-way" class="anchor" href="#the-orm-way" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The ORM way</h3>

<p>In software development, the Object-relational mapping (ORM) is a widely-used technique. Different libraries exist for the various language (Doctrine for PHP or Hibernate for Java for example).</p>

<p>The motivation to use an ORM is to easily set up and configure a SQLite database on Android.
It's also very powerful when setting up relationships. At least, it provides very fluent API to execute CRUD operations on the database.</p>

<h4>
<a id="ormlite" class="anchor" href="#ormlite" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>OrmLite</h4>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_ormlite.png" alt="OrmLite logo"></p>

<p>That's why I chose one of the most famous ORM on Android: <a href="http://ormlite.com/sqlite_java_android_orm.shtml">OrmLite</a>.</p>

<p>The first step is to set up our POJO to be mapped by ORMLite.</p>

<p>I created an abstract class to match the classical Android approach with its <code>_id</code> column:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">AbstractOrmLiteEntity</span> {
    <span class="pl-k">@DatabaseField</span>(<span class="pl-c1">columnName</span> <span class="pl-k">=</span> <span class="pl-smi">BaseColumns</span><span class="pl-k">.</span>_ID, <span class="pl-c1">generatedId</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>)
    <span class="pl-k">protected</span> <span class="pl-k">long</span> _id;

    <span class="pl-c">//region Getter</span>
    <span class="pl-k">public</span> <span class="pl-k">long</span> <span class="pl-en">getBaseId</span>() {
        <span class="pl-k">return</span> _id;
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>Now I simply create my POJO class (i.e., <code>Repo</code> for this example):</p>

<div class="highlight highlight-source-java"><pre>@DatabaseTable(tableName <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>REPO<span class="pl-pds">"</span></span>, daoClass <span class="pl-k">=</span> <span class="pl-smi">DAORepo</span><span class="pl-k">.</span>class)
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">RepoEntity</span> <span class="pl-k">extends</span> <span class="pl-e">AbstractOrmLiteEntity</span> <span class="pl-k">implements</span> <span class="pl-e">Serializable</span> {
    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">Integer</span> id;

    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> name;

    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> location;

    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> url;
}</pre></div>

<p>Now let's have a look on the DAO. This design pattern aims at accessing to the concrete data through an abstract interface. It describes and implements specific data operations to conform to the single responsibility principle.</p>

<p>Fortunately, OrmLite provides the <a href="http://ormlite.com/javadoc/ormlite-core/com/j256/ormlite/dao/Dao.html">Dao interface</a> and its implementation: <a href="http://ormlite.com/javadoc/ormlite-core/com/j256/ormlite/dao/BaseDaoImpl.html">BaseDaoImpl</a>. All the traditional CRUD operations I need are available.</p>

<p>Unfortunately, there are executing synchronously. That's where RxJava comes wisely to perform those operations asynchronously.</p>

<p>So I rewrote all the available methods in the RxJava-way.</p>

<p>So I created an interface as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">IRxDao</span>&lt;T, ID&gt; <span class="pl-k">extends</span> <span class="pl-e">Dao&lt;<span class="pl-smi">T</span>, <span class="pl-smi">ID</span>&gt;</span></pre></div>

<p>where I declared all the available methods of <code>Dao</code> with the "rx" prefix. They all return an <code>Observable</code> object with the type of return from the standard method.</p>

<p>Then I implemented this interface through an abstract class I declared like:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">RxBaseDaoImpl</span>&lt;DataType <span class="pl-k">extends</span> <span class="pl-e">AbstractOrmLiteEntity</span>, <span class="pl-e">IdType</span>&gt; extends <span class="pl-e">BaseDaoImpl&lt;<span class="pl-smi">DataType</span>, <span class="pl-smi">IdType</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">IRxDao&lt;<span class="pl-smi">DataType</span>, <span class="pl-smi">IdType</span>&gt;</span></pre></div>

<p>As I always use <code>long</code> as ID type, I define the following abstract class:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">AbstractBaseDAOImpl</span>&lt;DataType <span class="pl-k">extends</span> <span class="pl-e">AbstractOrmLiteEntity</span>&gt; extends <span class="pl-e">RxBaseDaoImpl&lt;<span class="pl-smi">DataType</span>, <span class="pl-smi">Long</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">IOrmLiteEntityDAO&lt;<span class="pl-smi">DataType</span>&gt;</span> {
    <span class="pl-c">//region Constructors matching super</span>
    <span class="pl-k">protected</span> <span class="pl-en">AbstractBaseDAOImpl</span>(<span class="pl-k">final</span> <span class="pl-k">Class&lt;<span class="pl-smi">DataType</span>&gt;</span> <span class="pl-v">poDataClass</span>) <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-v">super</span>(poDataClass);
    }

    <span class="pl-k">public</span> <span class="pl-en">AbstractBaseDAOImpl</span>(<span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>, <span class="pl-k">final</span> <span class="pl-k">Class&lt;<span class="pl-smi">DataType</span>&gt;</span> <span class="pl-v">poDataClass</span>) <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-v">super</span>(poConnectionSource, poDataClass);
    }

    <span class="pl-k">public</span> <span class="pl-en">AbstractBaseDAOImpl</span>(<span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>, <span class="pl-k">final</span> <span class="pl-k">DatabaseTableConfig&lt;<span class="pl-smi">DataType</span>&gt;</span> <span class="pl-v">poTableConfig</span>) <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-v">super</span>(poConnectionSource, poTableConfig);
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>So the declaration of my <code>DAORepo</code> simply becomes:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">DAORepo</span> <span class="pl-k">extends</span> <span class="pl-e">AbstractBaseDAOImpl&lt;<span class="pl-smi">RepoEntity</span>&gt;</span> {
    <span class="pl-c">//region Constructors matching super</span>
    <span class="pl-k">public</span> <span class="pl-en">DAORepo</span>(<span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>) <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-v">this</span>(poConnectionSource, <span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class);
    }

    <span class="pl-k">public</span> <span class="pl-en">DAORepo</span>(<span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>, <span class="pl-k">final</span> <span class="pl-k">Class&lt;<span class="pl-smi">RepoEntity</span>&gt;</span> <span class="pl-v">poDataClass</span>) <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-v">super</span>(poConnectionSource, poDataClass);
    }

    <span class="pl-k">public</span> <span class="pl-en">DAORepo</span>(<span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>, <span class="pl-k">final</span> <span class="pl-k">DatabaseTableConfig&lt;<span class="pl-smi">RepoEntity</span>&gt;</span> <span class="pl-v">poTableConfig</span>) <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-v">super</span>(poConnectionSource, poTableConfig);
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>Moreover, ORMLite provides us an abstract subclass of <code>SQLiteOpenHelper</code>, called <code>OrmLiteSqliteOpenHelper</code>. So, to declare the open helper we need, we simply have to write:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">DatabaseHelperAndroidStarter</span> <span class="pl-k">extends</span> <span class="pl-e">OrmLiteSqliteOpenHelper</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">DATABASE_NAME</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>android_starter.db<span class="pl-pds">"</span></span>;
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">int</span> <span class="pl-c1">DATABASE_VERSION</span> <span class="pl-k">=</span> <span class="pl-c1">1</span>;

    <span class="pl-c">//region Constructor</span>
    <span class="pl-k">public</span> <span class="pl-en">DatabaseHelperAndroidStarter</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        <span class="pl-v">super</span>(poContext, <span class="pl-c1">DATABASE_NAME</span>, <span class="pl-c1">null</span>, <span class="pl-c1">DATABASE_VERSION</span>);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Methods to override</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">@SneakyThrows</span>(<span class="pl-smi">SQLException</span><span class="pl-k">.</span>class)
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">SQLiteDatabase</span> <span class="pl-v">poDatabase</span>, <span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>) {
        <span class="pl-smi">TableUtils</span><span class="pl-k">.</span>createTable(poConnectionSource, <span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">@SneakyThrows</span>(<span class="pl-smi">SQLException</span><span class="pl-k">.</span>class)
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onUpgrade</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">SQLiteDatabase</span> <span class="pl-v">poDatabase</span>, <span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> <span class="pl-v">poConnectionSource</span>, <span class="pl-k">final</span> <span class="pl-k">int</span> <span class="pl-v">piOldVersion</span>, <span class="pl-k">final</span> <span class="pl-k">int</span> <span class="pl-v">piNewVersion</span>) {
        <span class="pl-smi">TableUtils</span><span class="pl-k">.</span>dropTable(poConnectionSource, <span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class, <span class="pl-c1">true</span>);
        onCreate(poDatabase, poConnectionSource);
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>We can see that ORMLite provides the utils class <a href="http://ormlite.com/javadoc/ormlite-core/com/j256/ormlite/table/TableUtils.html"><code>TableUtils</code></a> where helpful methods come to create or drop a table according to its mapped Java class.</p>

<p>At this time, don't pay attention to the <code>@SneakyThrows</code>. It comes from Lombok. I'll give more details about it in a future section. Just remind that it allows us no to write the <code>try/catch</code> statement by ourself, the annotation processor writes it for us, and we don't have compilation errors.</p>

<p>Now, it becomes very easy to deal with data. We just need a <code>DatabaseHelperAndroidStarter</code>:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-smi">DatabaseHelperAndroidStarter</span> getDatabaseHelperAndroidStarter(@<span class="pl-smi">NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> poContext) {
    <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">DatabaseHelperAndroidStarter</span>(poContext);
}</pre></div>

<p>and we can get an instance of the <code>DAORepo</code> as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-smi">DAORepo</span> getDAORepo(@<span class="pl-smi">NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">DatabaseHelperAndroidStarter</span> poDatabaseHelperAndroidStarter) {
    <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">DAORepo</span>(poDatabaseHelperAndroidStarter<span class="pl-k">.</span>getConnectionSource());
}</pre></div>

<p>In a <code>Fragment</code>, we can get all the repo through the following call:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">private</span> <span class="pl-k">void</span> rxGetRepos() {
    mSubscriptionGetRepos <span class="pl-k">=</span> <span class="pl-smi">AndroidObservable</span><span class="pl-k">.</span>bindFragment(getView(), getDatabaseRepos())
            .subscribeOn(<span class="pl-smi">Schedulers</span><span class="pl-k">.</span>newThread())
            .observeOn(<span class="pl-smi">AndroidSchedulers</span><span class="pl-k">.</span>mainThread())
            .subscribe(
                    (<span class="pl-k">final</span> <span class="pl-k">List&lt;<span class="pl-smi">RepoEntity</span>&gt;</span> ploRepos) <span class="pl-k">-</span><span class="pl-k">&gt;</span> { <span class="pl-c">// onNext</span>
                        <span class="pl-c">// TODO deal with repos</span>
                    },
                    (<span class="pl-k">final</span> <span class="pl-smi">Throwable</span> poException) <span class="pl-k">-</span><span class="pl-k">&gt;</span> { <span class="pl-c">// onError</span>
                        mSubscriptionGetRepos <span class="pl-k">=</span> <span class="pl-c1">null</span>;
                        <span class="pl-c">// TODO deal with error</span>
                    },
                    () <span class="pl-k">-</span><span class="pl-k">&gt;</span> { <span class="pl-c">// onCompleted</span>
                       mSubscriptionGetRepos <span class="pl-k">=</span> <span class="pl-c1">null</span>;
                    }
            );
}</pre></div>

<p>And the <code>getDatabaseRepos</code> is simply defined as:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">private</span> <span class="pl-k">Observable&lt;<span class="pl-k">List&lt;<span class="pl-smi">RepoEntity</span>&gt;</span>&gt;</span> getDatabaseRepos() {
    <span class="pl-k">return</span> daoRepo<span class="pl-k">.</span>rxQueryForAll();
}</pre></div>

<p>But a question remains: how to get repo from network, parse it and store it in our database?</p>

<p>A simple response could be gather all annotations in the same Java class. But we obtain a class with all the responsibilities of both network and database configuration.</p>

<p>My goal is to keep a class to interact with the network, <code>DTORepo</code> ; and one to map the database, <code>RepoEntity</code>. Basically, they have common fields, with the same names. So I need a tool to convert DTO to Entity. That's where <a href="https://github.com/txusballesteros/android-transformer">Android Transformer</a> comes to the rescue:</p>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_transformer.png" alt="Android Transformer logo"></p>

<p>It provides two main annotations:</p>

<ul>
<li>
<code>@Mappable</code> to indicate the class it is mapped to</li>
<li>
<code>@Mapped</code> to indicate a member should be bound</li>
</ul>

<p>So, our <code>RepoEntity</code> class becomes:</p>

<div class="highlight highlight-source-java"><pre>@Mappable(with <span class="pl-k">=</span> <span class="pl-smi">DTORepo</span><span class="pl-k">.</span>class)
@DatabaseTable(tableName <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>REPO<span class="pl-pds">"</span></span>, daoClass <span class="pl-k">=</span> <span class="pl-smi">DAORepo</span><span class="pl-k">.</span>class)
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">RepoEntity</span> <span class="pl-k">extends</span> <span class="pl-e">AbstractOrmLiteEntity</span> <span class="pl-k">implements</span> <span class="pl-e">Serializable</span> {
    <span class="pl-k">@Mapped</span>
    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">Integer</span> id;

    <span class="pl-k">@Mapped</span>
    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> name;

    <span class="pl-k">@Mapped</span>
    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> location;

    <span class="pl-k">@Mapped</span>
    <span class="pl-k">@DatabaseField</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> url;
}</pre></div>

<p>And now we can transform a DTO to an Entity as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">final</span> <span class="pl-smi">Transformer</span> loTransformerRepo <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Transformer</span>.<span class="pl-smi">Builder</span>()<span class="pl-k">.</span>build(<span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class);
<span class="pl-k">final</span> <span class="pl-smi">RepoEntity</span> loRepo <span class="pl-k">=</span> loTransformerRepo<span class="pl-k">.</span>transform(loDTORepo, <span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class);</pre></div>

<hr>

<p>As a conclusion: </p>

<ul>
<li>we have a simple way to define a new class mapping a SQLite class</li>
<li>we conforms to the single responsibility principle by providing a dedicated implementation of <code>AbstractBaseDAOImpl</code>
</li>
<li>we access to CRUD operations, in an asynchronous way, thanks to RxJava </li>
</ul>

<p>Note that we can boost the DAOs creations by generating an ORMLite configuration file at compile-time thanks to the <a href="https://github.com/stephanenicolas/ormlite-android-gradle-plugin">"ormgap" plugin</a>.</p>

<hr>

<h3>
<a id="the-contentprovider-way" class="anchor" href="#the-contentprovider-way" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The <code>ContentProvider</code> way</h3>

<p>A widely use approach is to set up a <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>. Personally, I came to it thanks to the <a href="https://github.com/google/iosched"><em>iosched</em> application open sourced by Google</a>. That's where I saw how to configure and use this concept.</p>

<p>I'd like to say that I find that it's a powerful mechanism, especially when it's used in combination with <a href="http://developer.android.com/reference/android/database/Cursor.html"><code>Cursor</code></a> and its derivatives like <a href="http://developer.android.com/reference/android/content/CursorLoader.html"><code>CursorLoader</code></a> and <a href="http://developer.android.com/reference/android/widget/CursorAdapter.html"><code>CursorAdapter</code></a>.</p>

<p>It's performant and reliable. Moreover, it can be boosted up with some tips like overriding the <code>bulkInsert</code> method and use a single SQL transaction.</p>

<p>The only thing I regret is that it's not petty to set up and we write a lot of boilerplate code.
That's why I looked for a simpler solution to declare my content provider easily, but to maintain control over the implementation of some methods of the ContentProvider. In other word, I must deal with a <code>ContentProvider</code> subclass.</p>

<p>That's why I like <a href="https://github.com/TimotheeJeannin/ProviGen">ProviGen</a>.</p>

<p>Here are the advantages I see:</p>

<ul>
<li>it's simple to declare a <a href="http://developer.android.com/guide/topics/providers/content-provider-basics.html#ContractClasses">contract class</a>, a common practice when using content providers</li>
<li>we deal with a <code>ProviGenProvider</code>, that is a subclass of <code>ContentProvider</code>
</li>
<li>it provides a default implementation of the <code>SQLiteOpenHelper</code>
</li>
<li>it's possible to provide a custom implementation of the <code>SQLiteOpenHelper</code>
</li>
<li>a <code>TableBuilder</code> class is available to help developers building their SQL tables with a fluent API</li>
</ul>

<p>Each "model" class have its own contract class.
In few lines, the <code>ProviGenProvider</code> subclass provides a way to register all these contract class.</p>

<p>It becomes very fast to set up a basic content provider. The fact to maintain control over this implementation, so that we can </p>

<ul>
<li>add custom URIs and deal with it (for more complex jobs for example)</li>
<li>speed up this content provider performances</li>
</ul>

<p>Another tool I like to speed up content provider management is <a href="https://github.com/chalup/microorm">MicroOrm</a>. Just annotate your POJO with <code>@Column</code>, giving it the name of the column to bind (the constant coming from the contract class is perfect for that!), and then you:</p>

<ul>
<li>build <a href="http://developer.android.com/reference/android/content/ContentValues.html"><code>ContentValues</code></a> easily through a <code>MicroOrm</code> instance and its <code>toContentValues</code> method, taking a POJO instance as parameter</li>
<li>build a POJO instance from a <code>Cursor</code> thanks to the <code>fromCursor</code> method of the <code>MicroOrm</code> instance</li>
<li>build a list of POJO from a <code>Cursor</code> thanks to the <code>listFromCursor</code> method of the <code>MicroOrm</code> instance</li>
</ul>

<p>A very simple way to deal with <code>Cursor</code> and <code>ContentValues</code>, inescapable when using a content provider.</p>

<h2>
<a id="dependency-injection" class="anchor" href="#dependency-injection" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dependency injection</h2>

<p>The dependency injection (a.k.a. "DI") is a powerful design pattern that implements inversion of control to resolve dependencies.</p>

<p>No need to reming how useful can be the DI:</p>

<ul>
<li>easy to read</li>
<li>easy to maintain</li>
<li>easy to test (because it's easy to mock an element)</li>
</ul>

<p>A major solution to use DI on Android is <a href="http://google.github.io/dagger/">Dagger2</a>. Its main advantage I see is that the dependency analysis is done at the compile time. Potential errors are notified as soon as possible.</p>

<p>This is not the place to detail all the capabilities of Dagger2. 
<a href="http://code.tutsplus.com/tutorials/dependency-injection-with-dagger-2-on-android--cms-23345">This article, written by Kerry Perez Huanca</a>, provides a good summary of the Dagger2 workflow with its key concepts:</p>

<ol>
<li>Identify the dependent objects and its dependencies.</li>
<li>Create a class with the <code>@Module</code> annotation, using the <code>@Provides</code> annotation for every method that returns a dependency.</li>
<li>Request dependencies in your dependent objects using the <code>@Inject</code> annotation.</li>
<li>Create an interface using the <code>@Component</code> annotation and add the classes with the <code>@Module</code> annotation created in the second step.</li>
<li>Create an object of the <code>@Component</code> interface to instantiate the dependent object with its dependencies.</li>
</ol>

<p>To have a full taste of Dagger2, I suggest you to read this <a href="http://fernandocejas.com/2015/04/11/tasting-dagger-2-on-android/">excellent article written by Fernando Cejas</a>.</p>

<p>Now, according to our sample project, following the workflow described up above, let's set up Dagger2 in the project.</p>

<h4>
<a id="1-identify-the-dependent-objects-and-its-dependencies" class="anchor" href="#1-identify-the-dependent-objects-and-its-dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Identify the dependent objects and its dependencies:</h4>

<ul>
<li>the <code>ServiceQueryExecutor</code> requires an instance of <code>JobManager</code>
</li>
<li>the <code>ServiceQueryExecutor</code> requires an instance of <code>MerlinsBeard</code>
</li>
<li>each query needs a <code>BusManager</code> to publish its termination</li>
<li>each observers (<code>Fragment</code> for example) requires a <code>BusManager</code> to register and listen for queries termination</li>
<li>each DAO needs a <code>DatabaseHelperAndroidStarter</code> to be built successfully</li>
<li>some queries needs a <code>DAORepo</code> to delete, insert or update repo</li>
<li>some queries needs a <code>Transformer</code> to convert <code>DTORepo</code> to <code>RepoEntity</code>
</li>
<li>some elements needs a <code>DAORepo</code> to query repo</li>
<li>all queries needs a <code>GitHubService</code> to perform REST calls</li>
<li>invoking elements requires an instance of <code>QueryFactory</code> to start REST calls</li>
</ul>

<h4>
<a id="2-its-now-time-to-have-a-look-at-our-modules-for-example" class="anchor" href="#2-its-now-time-to-have-a-look-at-our-modules-for-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. It's now time to have a look at our modules, for example:</h4>

<ul>
<li>
<code>ModuleAsync</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleAsync</span> {

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">JobManager</span> <span class="pl-en">provideJobManager</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">Configuration</span> loConfiguration <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Configuration</span>.<span class="pl-smi">Builder</span>(poContext)
                .minConsumerCount(<span class="pl-c1">1</span>) <span class="pl-c">//always keep at least one consumer alive</span>
                .maxConsumerCount(<span class="pl-c1">3</span>) <span class="pl-c">//up to 3 consumers at a time</span>
                .loadFactor(<span class="pl-c1">3</span>) <span class="pl-c">//3 jobs per consumer</span>
                .consumerKeepAlive(<span class="pl-c1">120</span>) <span class="pl-c">//wait 2 minute</span>
                .build();
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">JobManager</span>(poContext, loConfiguration);
    }
}</pre></div>

<ul>
<li>
<code>ModuleBus</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleBus</span> {

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">BusManager</span> <span class="pl-en">provideBusManager</span>() {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">BusManager</span>();
    }
}</pre></div>

<ul>
<li>
<code>ModuleContext</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleContext</span> {
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> mContext;

    <span class="pl-k">public</span> <span class="pl-en">ModuleContext</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        mContext <span class="pl-k">=</span> poContext;
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">public</span> <span class="pl-smi">Context</span> <span class="pl-en">provideContext</span>() {
        <span class="pl-k">return</span> mContext;
    }
}</pre></div>

<ul>
<li>
<code>ModuleDatabase</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleDatabase</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">TAG</span> <span class="pl-k">=</span> <span class="pl-smi">ModuleDatabase</span><span class="pl-k">.</span>class<span class="pl-k">.</span>getSimpleName();
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-c1">DEBUG</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>;

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">DatabaseHelperAndroidStarter</span> <span class="pl-en">provideDatabaseHelperAndroidStarter</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">DatabaseHelperAndroidStarter</span>(poContext);
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">DAORepo</span> <span class="pl-en">provideDAORepo</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">DatabaseHelperAndroidStarter</span> <span class="pl-v">poDatabaseHelperAndroidStarter</span>) {
        <span class="pl-k">try</span> {
            <span class="pl-k">final</span> <span class="pl-smi">ConnectionSource</span> loConnectionSource <span class="pl-k">=</span> poDatabaseHelperAndroidStarter<span class="pl-k">.</span>getConnectionSource();
            <span class="pl-k">final</span> <span class="pl-k">DatabaseTableConfig&lt;<span class="pl-smi">RepoEntity</span>&gt;</span> loTableConfig <span class="pl-k">=</span> <span class="pl-smi">DatabaseTableConfigUtil</span><span class="pl-k">.</span>fromClass(loConnectionSource, <span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class);
            <span class="pl-k">if</span>(loTableConfig <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
                <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">DAORepo</span>(loConnectionSource, loTableConfig);
            } <span class="pl-k">else</span> {
                <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">DAORepo</span>(loConnectionSource);
            }
        } <span class="pl-k">catch</span> (<span class="pl-k">final</span> <span class="pl-smi">SQLException</span> loException) {
            <span class="pl-k">if</span> (<span class="pl-smi">BuildConfig</span><span class="pl-c1"><span class="pl-k">.</span>DEBUG</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">DEBUG</span>) {
                <span class="pl-smi">Logger</span><span class="pl-k">.</span>t(<span class="pl-c1">TAG</span>)<span class="pl-k">.</span>e(loException, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
            }
        }
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
}</pre></div>

<ul>
<li>
<code>ModuleEnvironment</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleEnvironment</span> {

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">IEnvironment</span> <span class="pl-en">provideEnvironment</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">BuildConfig</span><span class="pl-c1"><span class="pl-k">.</span>ENVIRONMENT</span>;
    }
}</pre></div>

<ul>
<li>
<code>ModuleRest</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleRest</span> {

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">OkHttpClient</span> <span class="pl-en">provideOkHttpClient</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">IEnvironment</span> <span class="pl-v">poEnvironment</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">HttpLoggingInterceptor</span> loHttpLoggingInterceptor <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">HttpLoggingInterceptor</span>();
        loHttpLoggingInterceptor<span class="pl-k">.</span>setLevel(poEnvironment<span class="pl-k">.</span>getHttpLoggingInterceptorLevel());
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">OkHttpClient</span>.<span class="pl-smi">Builder</span>()
                .addInterceptor(loHttpLoggingInterceptor)
                .build();
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">GitHubService</span> <span class="pl-en">provideGithubService</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">OkHttpClient</span> <span class="pl-v">poOkHttpClient</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">Retrofit</span> loRetrofit <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Retrofit</span>.<span class="pl-smi">Builder</span>()
                .baseUrl(<span class="pl-s"><span class="pl-pds">"</span>https://api.github.com<span class="pl-pds">"</span></span>)
                .client(poOkHttpClient)
                .addConverterFactory(<span class="pl-smi">JacksonConverterFactory</span><span class="pl-k">.</span>create())
                .addCallAdapterFactory(<span class="pl-k">new</span> <span class="pl-smi">ErrorHandlingExecutorCallAdapterFactory</span>(<span class="pl-k">new</span> <span class="pl-smi">ErrorHandlingExecutorCallAdapterFactory</span>.<span class="pl-smi">MainThreadExecutor</span>()))
                .build();
        <span class="pl-k">return</span> loRetrofit<span class="pl-k">.</span>create(<span class="pl-smi">GitHubService</span><span class="pl-k">.</span>class);
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">QueryFactory</span> <span class="pl-en">provideQueryFactory</span>() {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">QueryFactory</span>();
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">Merlin</span> <span class="pl-en">provideMerlin</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Merlin</span>.<span class="pl-smi">Builder</span>()
                .withConnectableCallbacks()
                .withDisconnectableCallbacks()
                .withBindableCallbacks()
                .withLogging(<span class="pl-c1">true</span>)
                .build(poContext);
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">MerlinsBeard</span> <span class="pl-en">provideMerlinsBeard</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        <span class="pl-k">return</span> <span class="pl-smi">MerlinsBeard</span><span class="pl-k">.</span>from(poContext);
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">Picasso</span> <span class="pl-en">providePicasso</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">Picasso</span> loPicasso <span class="pl-k">=</span> <span class="pl-smi">Picasso</span><span class="pl-k">.</span>with(poContext);
        loPicasso<span class="pl-k">.</span>setIndicatorsEnabled(<span class="pl-c1">true</span>);
        loPicasso<span class="pl-k">.</span>setLoggingEnabled(<span class="pl-c1">true</span>);
        <span class="pl-k">return</span> loPicasso;
    }

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">public</span> <span class="pl-smi">PicassoModule</span> <span class="pl-en">providePicassoModule</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Picasso</span> <span class="pl-v">poPicasso</span>) {
        <span class="pl-k">return</span>  <span class="pl-k">new</span> <span class="pl-smi">PicassoModule</span>(poPicasso);
    }
}</pre></div>

<ul>
<li>
<code>ModuleTransformer</code>:</li>
</ul>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ModuleTransformer</span> {
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">TRANSFORMER_REPO</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>TRANSFORMER_REPO<span class="pl-pds">"</span></span>;

    <span class="pl-k">@Provides</span>
    <span class="pl-k">@Singleton</span>
    <span class="pl-k">@Named</span>(<span class="pl-c1">TRANSFORMER_REPO</span>)
    <span class="pl-k">public</span> <span class="pl-smi">Transformer</span> <span class="pl-en">provideTransformerRepo</span>() {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Transformer</span>.<span class="pl-smi">Builder</span>()
                .build(<span class="pl-smi">RepoEntity</span><span class="pl-k">.</span>class);
    }
}</pre></div>

<p>Concerning the last one, <code>ModuleTransformer</code>, as it's impossible to strongly type an instance of <code>Transformer</code>, we use the naming convention thanks to the <code>@Named</code> annotation.</p>

<p>It now can be used like:</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Inject</span>
@Named(<span class="pl-smi">ModuleTransformer</span><span class="pl-c1"><span class="pl-k">.</span>TRANSFORMER_REPO</span>)
<span class="pl-smi">Transformer</span> transformerRepo;</pre></div>

<p>To speed up the set up of components, I'm going to use the annotations-based <a href="https://github.com/lukaspili/Auto-Dagger2">Auto-Dagger2</a> library. Annotations are used compile-time to generate boilerplate code of the components.</p>

<p>On the one hand, I've to declare my <code>Application</code> subclass like this:</p>

<div class="highlight highlight-source-java"><pre>@AutoComponent(
        modules <span class="pl-k">=</span> {
                <span class="pl-smi">ModuleAsync</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleBus</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleContext</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleDatabase</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleEnvironment</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleRest</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleTransformer</span><span class="pl-k">.</span>class
        }
)
@<span class="pl-smi">Singleton</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ApplicationAndroidStarter</span> <span class="pl-k">extends</span> <span class="pl-e">MultiDexApplication</span></pre></div>

<p>The <code>@AutoComponent</code> lists all the modules to provide in the generated component.</p>

<p>On the other hand, on each element that needs injected elements, I have to add the <code>@AutoInjector(ApplicationAndroidStarter.class)</code> annotation, pointing on the class annotated with <code>@AutoComponent</code>. That way, I obtain a valid component declaration, auto-generated, as follows:</p>

<div class="highlight highlight-source-java"><pre>@Component(
    modules <span class="pl-k">=</span> {
        <span class="pl-smi">ModuleAsync</span><span class="pl-k">.</span>class,
        <span class="pl-smi">ModuleBus</span><span class="pl-k">.</span>class,
        <span class="pl-smi">ModuleContext</span><span class="pl-k">.</span>class,
        <span class="pl-smi">ModuleDatabase</span><span class="pl-k">.</span>class,
        <span class="pl-smi">ModuleEnvironment</span><span class="pl-k">.</span>class,
        <span class="pl-smi">ModuleRest</span><span class="pl-k">.</span>class,
        <span class="pl-smi">ModuleTransformer</span><span class="pl-k">.</span>class
    }
)
@<span class="pl-smi">Singleton</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">ApplicationAndroidStarterComponent</span> {
  <span class="pl-k">void</span> <span class="pl-en">inject</span>(<span class="pl-smi">ApplicationAndroidStarter</span> <span class="pl-v">applicationAndroidStarter</span>);

  <span class="pl-k">void</span> <span class="pl-en">inject</span>(<span class="pl-smi">ServiceQueryExecutor</span> <span class="pl-v">serviceQueryExecutor</span>);

  <span class="pl-k">void</span> <span class="pl-en">inject</span>(<span class="pl-smi">QueryGetRepos</span> <span class="pl-v">queryGetRepos</span>);

  <span class="pl-k">void</span> <span class="pl-en">inject</span>(<span class="pl-smi">FragmentRepoList</span> <span class="pl-v">fragmentRepoList</span>);

  <span class="pl-c">// ...</span>

}</pre></div>

<p>It allows me not to write code of the component, and not to add manually an <code>inject</code> method each time a new element needs injection.</p>

<p>For example, my <code>ServiceQueryExecutor</code> is simply declared as follows:</p>

<div class="highlight highlight-source-java"><pre>@AutoInjector(<span class="pl-smi">ApplicationAndroidStarter</span><span class="pl-k">.</span>class)
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ServiceQueryExecutor</span> <span class="pl-k">extends</span> <span class="pl-e">IntentService</span></pre></div>

<p>What a precious time saving, isn't it?</p>

<h2>
<a id="the-mvp-architecture" class="anchor" href="#the-mvp-architecture" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The MVP architecture</h2>

<p>As an introduction to the MVP architecture, its motivations and its benefits, I invite you to read the <a href="http://hannesdorfmann.com/mosby/">very interesting website</a> coming with the <a href="https://github.com/sockeqwe/mosby">Mosby library</a>.</p>

<p>All you need to know about <a href="http://hannesdorfmann.com/mosby/mvp/">MVP fundamentals</a>, <a href="http://hannesdorfmann.com/mosby/viewstate/">ViewState</a> and LCE (Loading-Content-Error) is well explained in this website.</p>

<p>Another useful tool is the <a href="http://developer.android.com/tools/data-binding/guide.html">Android DataBinding library</a>. Using this one makes our <em>View</em> and our <em>Model</em> tightly coupled. And the have a bidirectional binding. It's the glue we were missing. With a few configuration, we can plug the view (its <code>layout.xml</code> file and <code>Activity</code>/<code>Fragment</code>) to the model (traditionally, a POJO). I let the official documentation tells you how to use this library.</p>

<p>To explain the MVP architecture using Mosby, I'm going to present the use case of <em>displaying the detail of a repo</em>.</p>

<p>The first step is to design the model class corresponding to the screen we are going to display:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-k">class</span> <span class="pl-en">ModelRepoDetail</span> {
    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-smi">RepoEntity</span> repo; <span class="pl-c">// the repo to display</span>

    <span class="pl-k">public</span> <span class="pl-en">ModelRepoDetail</span>(<span class="pl-k">final</span> <span class="pl-smi">RepoEntity</span> <span class="pl-v">poRepo</span>) {
        repo <span class="pl-k">=</span> poRepo;
    }
}</pre></div>

<p>Now we define the corresponding <em>View</em> interface:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">ViewRepoDetail</span> <span class="pl-k">extends</span> <span class="pl-e">MvpLceView&lt;<span class="pl-smi">ModelRepoDetail</span>&gt;</span> {
    <span class="pl-k">void</span> <span class="pl-en">showEmpty</span>();
}</pre></div>

<p>The next step is to define the presenter:</p>

<div class="highlight highlight-source-java"><pre>@AutoInjector(<span class="pl-smi">ApplicationAndroidStarter</span><span class="pl-k">.</span>class) <span class="pl-c">// to automatically add inject method in component</span>
<span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-k">class</span> <span class="pl-en">PresenterRepoDetail</span> <span class="pl-k">extends</span> <span class="pl-e">MvpBasePresenter&lt;<span class="pl-smi">ViewRepoDetail</span>&gt;</span> {

    <span class="pl-c">//region Injected fields</span>
    <span class="pl-k">@Inject</span>
    <span class="pl-smi">DAORepo</span> daoRepo; <span class="pl-c">// we need the DAO to load the repo from its ID</span>
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Fields</span>
    <span class="pl-k">private</span> <span class="pl-smi">Subscription</span> mSubscriptionGetRepo; <span class="pl-c">// the RxJava subscription, to destroy it when needed</span>
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Constructor</span>
    <span class="pl-k">public</span> <span class="pl-en">PresenterRepoDetail</span>() {
        <span class="pl-c">// inject necessary fields via the component</span>
        <span class="pl-smi">ApplicationAndroidStarter</span><span class="pl-k">.</span>sharedApplication()<span class="pl-k">.</span>componentApplication()<span class="pl-k">.</span>inject(<span class="pl-v">this</span>);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Visible API</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">loadRepo</span>(<span class="pl-k">final</span> <span class="pl-k">long</span> <span class="pl-v">plRepoId</span>, <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbPullToRefresh</span>) {
        <span class="pl-k">if</span> (isViewAttached()) {
            getView()<span class="pl-k">.</span>showLoading(pbPullToRefresh);
        }
        <span class="pl-c">// get repo asynchronously via RxJava</span>
        rxGetRepo(plRepoId);
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onDestroy</span>() {
        <span class="pl-c">// destroy the RxJava subscribtion</span>
        <span class="pl-k">if</span> (mSubscriptionGetRepo <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            mSubscriptionGetRepo<span class="pl-k">.</span>unsubscribe();
            mSubscriptionGetRepo <span class="pl-k">=</span> <span class="pl-c1">null</span>;
        }
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Reactive job</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">rxGetRepo</span>(<span class="pl-k">final</span> <span class="pl-k">long</span> <span class="pl-v">plRepoId</span>) {
        mSubscriptionGetRepo <span class="pl-k">=</span> <span class="pl-smi">AndroidObservable</span><span class="pl-k">.</span>bindFragment(getView(), getDatabaseRepo(plRepoId))
                .subscribeOn(<span class="pl-smi">Schedulers</span><span class="pl-k">.</span>newThread())
                .observeOn(<span class="pl-smi">AndroidSchedulers</span><span class="pl-k">.</span>mainThread())
                .subscribe(
                        (<span class="pl-k">final</span> <span class="pl-smi">RepoEntity</span> poRepo) <span class="pl-k">-</span><span class="pl-k">&gt;</span> { <span class="pl-c">// onNext</span>
                            <span class="pl-k">if</span> (isViewAttached()) {
                                getView()<span class="pl-k">.</span>setData(<span class="pl-k">new</span> <span class="pl-smi">ModelRepoDetail</span>(poRepo));
                                <span class="pl-k">if</span> (poRepo <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
                                    getView()<span class="pl-k">.</span>showEmpty();
                                } <span class="pl-k">else</span> {
                                    getView()<span class="pl-k">.</span>showContent();
                                }
                            }
                        },
                        (<span class="pl-k">final</span> <span class="pl-smi">Throwable</span> poException) <span class="pl-k">-</span><span class="pl-k">&gt;</span> { <span class="pl-c">// onError</span>
                            mSubscriptionGetRepo <span class="pl-k">=</span> <span class="pl-c1">null</span>;
                            <span class="pl-k">if</span> (isViewAttached()) {
                                getView()<span class="pl-k">.</span>showError(poException, <span class="pl-c1">false</span>);
                            }
                        },
                        () <span class="pl-k">-</span><span class="pl-k">&gt;</span> { <span class="pl-c">// onCompleted</span>
                            mSubscriptionGetRepo <span class="pl-k">=</span> <span class="pl-c1">null</span>;
                        }
                );
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Database job</span>
    <span class="pl-k">@RxLogObservable</span>
    <span class="pl-k">private</span> <span class="pl-k">Observable&lt;<span class="pl-smi">RepoEntity</span>&gt;</span> <span class="pl-en">getDatabaseRepo</span>(<span class="pl-k">final</span> <span class="pl-k">long</span> <span class="pl-v">plRepoId</span>) {
        <span class="pl-k">return</span> daoRepo<span class="pl-k">.</span>rxQueryForId(plRepoId);
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>The main code is placed in the <code>rxGetRepo</code> method: it loads data from database and asks the view to configure itself according to the result (success: it should display data ; failure: it should display an error).</p>

<p>And now, let's have a look to the <code>FragmentRepoDetail</code>. Considering Mosby explanation, this fragment is part of the <em>View</em>. So, it should implements the <code>ViewRepoDetail</code> we've defined. To be closest to Mosby API, we make it inherit from <code>MvpFragment</code>, providing generic types <code>ViewRepoDetail</code> (for the <em>View</em>) and <code>PresenterRepoDetail</code> (for the <em>Presenter</em>).</p>

<p>So what we got:</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">FragmentWithArgs</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentRepoDetail</span>
        <span class="pl-k">extends</span> <span class="pl-e">MvpFragment&lt;<span class="pl-smi">ViewRepoDetail</span>, <span class="pl-smi">PresenterRepoDetail</span>&gt;</span>
        <span class="pl-k">implements</span> <span class="pl-e">ViewRepoDetail</span> {

    <span class="pl-c">//region FragmentArgs</span>
    <span class="pl-k">@Arg</span>
    <span class="pl-smi">Long</span> mItemId;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Fields</span>
    <span class="pl-k">private</span> <span class="pl-smi">Switcher</span> mSwitcher;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Injected views</span>
    <span class="pl-k">@Bind</span>(<span class="pl-smi">R</span><span class="pl-k">.</span><span class="pl-smi">id<span class="pl-k">.</span>FragmentRepoDetail_TextView_Empty</span>)
    <span class="pl-smi">TextView</span> mTextViewEmpty;
    <span class="pl-k">@Bind</span>(<span class="pl-smi">R</span><span class="pl-k">.</span><span class="pl-smi">id<span class="pl-k">.</span>FragmentRepoDetail_TextView_Error</span>)
    <span class="pl-smi">TextView</span> mTextViewError;
    <span class="pl-k">@Bind</span>(<span class="pl-smi">R</span><span class="pl-k">.</span><span class="pl-smi">id<span class="pl-k">.</span>FragmentRepoDetail_ProgressBar_Loading</span>)
    <span class="pl-smi">ProgressBar</span> mProgressBarLoading;
    <span class="pl-k">@Bind</span>(<span class="pl-smi">R</span><span class="pl-k">.</span><span class="pl-smi">id<span class="pl-k">.</span>FragmentRepoDetail_ContentView</span>)
    <span class="pl-smi">LinearLayout</span> mContentView;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Data-binding</span>
    <span class="pl-k">private</span> <span class="pl-smi">FragmentRepoDetailBinding</span> mBinding;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Default constructor</span>

    <span class="pl-c">/**</span>
<span class="pl-c">     * Mandatory empty constructor for the fragment manager to instantiate the</span>
<span class="pl-c">     * fragment (e.g. upon screen orientation changes).</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-en">FragmentRepoDetail</span>() {
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Lifecycle</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>(<span class="pl-k">final</span> <span class="pl-smi">Bundle</span> <span class="pl-v">poSavedInstanceState</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate(poSavedInstanceState);
        <span class="pl-smi">FragmentArgs</span><span class="pl-k">.</span>inject(<span class="pl-v">this</span>);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">View</span> <span class="pl-en">onCreateView</span>(<span class="pl-k">final</span> <span class="pl-smi">LayoutInflater</span> <span class="pl-v">poInflater</span>, <span class="pl-k">final</span> <span class="pl-smi">ViewGroup</span> <span class="pl-v">poContainer</span>,
                             <span class="pl-k">final</span> <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>) {
        mBinding <span class="pl-k">=</span> <span class="pl-smi">DataBindingUtil</span><span class="pl-k">.</span>inflate(poInflater, <span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>fragment_repo_detail, poContainer, <span class="pl-c1">false</span>);
        <span class="pl-k">return</span> mBinding<span class="pl-k">.</span>getRoot();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewCreated</span>(<span class="pl-k">final</span> <span class="pl-smi">View</span> <span class="pl-v">poView</span>, <span class="pl-k">final</span> <span class="pl-smi">Bundle</span> <span class="pl-v">poSavedInstanceState</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewCreated(poView, poSavedInstanceState);

        <span class="pl-smi">ButterKnife</span><span class="pl-k">.</span>bind(<span class="pl-v">this</span>, poView);

        mSwitcher <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Switcher</span>.<span class="pl-smi">Builder</span>()
                .withEmptyView(mTextViewEmpty)
                .withProgressView(mProgressBarLoading)
                .withErrorView(mTextViewError)
                .withContentView(mContentView)
                .build();

        loadData(<span class="pl-c1">false</span>);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onDestroyView</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onDestroyView();

        <span class="pl-smi">ButterKnife</span><span class="pl-k">.</span>unbind(<span class="pl-v">this</span>);

        <span class="pl-k">if</span> (mBinding <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            mBinding<span class="pl-k">.</span>unbind();
            mBinding <span class="pl-k">=</span> <span class="pl-c1">null</span>;
        }
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region MvpFragment</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">PresenterRepoDetail</span> <span class="pl-en">createPresenter</span>() {
        <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">PresenterRepoDetail</span>();
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region ViewRepoDetail</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">showEmpty</span>() {
        mSwitcher<span class="pl-k">.</span>showEmptyView();
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region MvpLceView</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">showContent</span>() {
        mSwitcher<span class="pl-k">.</span>showContentView();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">showLoading</span>(<span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbPullToRefresh</span>) {
        mSwitcher<span class="pl-k">.</span>showProgressView();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">showError</span>(<span class="pl-k">final</span> <span class="pl-smi">Throwable</span> <span class="pl-v">poThrowable</span>, <span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbPullToRefresh</span>) {
        mSwitcher<span class="pl-k">.</span>showErrorView();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setData</span>(<span class="pl-k">final</span> <span class="pl-smi">ModelRepoDetail</span> <span class="pl-v">poData</span>) {
        mBinding<span class="pl-k">.</span>setRepo(poData<span class="pl-k">.</span>repo);

        <span class="pl-k">final</span> <span class="pl-smi">Activity</span> loActivity <span class="pl-k">=</span> <span class="pl-v">this</span><span class="pl-k">.</span>getActivity();
        <span class="pl-k">final</span> <span class="pl-smi">CollapsingToolbarLayout</span> loAppBarLayout <span class="pl-k">=</span> (<span class="pl-smi">CollapsingToolbarLayout</span>) loActivity<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span><span class="pl-smi">id<span class="pl-k">.</span>ActivityRepoDetail_ToolbarLayout</span>);
        <span class="pl-k">if</span> (loAppBarLayout <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            loAppBarLayout<span class="pl-k">.</span>setTitle(poData<span class="pl-k">.</span>repo<span class="pl-k">.</span>url);
        }
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">loadData</span>(<span class="pl-k">final</span> <span class="pl-k">boolean</span> <span class="pl-v">pbPullToRefresh</span>) {
        <span class="pl-k">if</span> (mItemId <span class="pl-k">==</span> <span class="pl-c1">null</span>) {
            mSwitcher<span class="pl-k">.</span>showErrorView();
        } <span class="pl-k">else</span> {
            getPresenter()<span class="pl-k">.</span>loadRepo(mItemId<span class="pl-k">.</span>longValue(), pbPullToRefresh);
        }
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>At this point, don't worry, some annotation and classes are going to be described in a next section (<code>@FragmentArgsInherited</code>, <code>@Arg</code>, <code>@Bind</code>, <code>FragmentArgs</code>, <code>ButterKnife</code> and <code>Switcher</code>).</p>

<p>Finally, just have a look to the corresponding layout:</p>

<div class="highlight highlight-text-xml"><pre>&lt;?<span class="pl-ent">xml</span><span class="pl-e"> version</span>=<span class="pl-s"><span class="pl-pds">"</span>1.0<span class="pl-pds">"</span></span><span class="pl-e"> encoding</span>=<span class="pl-s"><span class="pl-pds">"</span>utf-8<span class="pl-pds">"</span></span>?&gt;
&lt;<span class="pl-ent">layout</span> <span class="pl-e">xmlns</span><span class="pl-e">:</span><span class="pl-e">android</span>=<span class="pl-s"><span class="pl-pds">"</span>http://schemas.android.com/apk/res/android<span class="pl-pds">"</span></span>
        <span class="pl-e">xmlns</span><span class="pl-e">:</span><span class="pl-e">tools</span>=<span class="pl-s"><span class="pl-pds">"</span>http://schemas.android.com/tools<span class="pl-pds">"</span></span>&gt;

    &lt;<span class="pl-ent">data</span>&gt;
        &lt;<span class="pl-ent">variable</span>
            <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>repo<span class="pl-pds">"</span></span>
            <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>fr.guddy.androidstarter.database.entities.RepoEntity<span class="pl-pds">"</span></span>/&gt;
    &lt;/<span class="pl-ent">data</span>&gt;

    &lt;<span class="pl-ent">FrameLayout</span>
        <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
        <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
        <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">orientation</span>=<span class="pl-s"><span class="pl-pds">"</span>vertical<span class="pl-pds">"</span></span>&gt;

        &lt;<span class="pl-ent">TextView</span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_TextView_Empty<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">gravity</span>=<span class="pl-s"><span class="pl-pds">"</span>center<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">text</span>=<span class="pl-s"><span class="pl-pds">"</span>@string/empty_repo<span class="pl-pds">"</span></span>/&gt;

        &lt;<span class="pl-ent">TextView</span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_TextView_Error<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">gravity</span>=<span class="pl-s"><span class="pl-pds">"</span>center<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">text</span>=<span class="pl-s"><span class="pl-pds">"</span>@string/error_repo<span class="pl-pds">"</span></span>/&gt;

        &lt;<span class="pl-ent">ProgressBar</span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_ProgressBar_Loading<span class="pl-pds">"</span></span>
            <span class="pl-e">style</span>=<span class="pl-s"><span class="pl-pds">"</span>?android:attr/progressBarStyleLarge<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>wrap_content<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>wrap_content<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_gravity</span>=<span class="pl-s"><span class="pl-pds">"</span>center<span class="pl-pds">"</span></span>/&gt;

        &lt;<span class="pl-ent">LinearLayout</span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_ContentView<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
            <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">orientation</span>=<span class="pl-s"><span class="pl-pds">"</span>vertical<span class="pl-pds">"</span></span>&gt;

            &lt;<span class="pl-ent">TextView</span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_TextView_Name<span class="pl-pds">"</span></span>
                <span class="pl-e">style</span>=<span class="pl-s"><span class="pl-pds">"</span>?android:attr/textAppearanceLarge<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>wrap_content<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">padding</span>=<span class="pl-s"><span class="pl-pds">"</span>16dp<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">text</span>=<span class="pl-s"><span class="pl-pds">"</span>@{repo.name}<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">textIsSelectable</span>=<span class="pl-s"><span class="pl-pds">"</span>true<span class="pl-pds">"</span></span>/&gt;

            &lt;<span class="pl-ent">TextView</span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_TextView_Location<span class="pl-pds">"</span></span>
                <span class="pl-e">style</span>=<span class="pl-s"><span class="pl-pds">"</span>?android:attr/textAppearanceMedium<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>wrap_content<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">padding</span>=<span class="pl-s"><span class="pl-pds">"</span>16dp<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">text</span>=<span class="pl-s"><span class="pl-pds">"</span>@{repo.location}<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">textIsSelectable</span>=<span class="pl-s"><span class="pl-pds">"</span>true<span class="pl-pds">"</span></span>/&gt;

            &lt;<span class="pl-ent">TextView</span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">id</span>=<span class="pl-s"><span class="pl-pds">"</span>@+id/FragmentRepoDetail_TextView_Url<span class="pl-pds">"</span></span>
                <span class="pl-e">style</span>=<span class="pl-s"><span class="pl-pds">"</span>?android:attr/textAppearanceSmall<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_width</span>=<span class="pl-s"><span class="pl-pds">"</span>match_parent<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">layout_height</span>=<span class="pl-s"><span class="pl-pds">"</span>wrap_content<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">padding</span>=<span class="pl-s"><span class="pl-pds">"</span>16dp<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">text</span>=<span class="pl-s"><span class="pl-pds">"</span>@{repo.url}<span class="pl-pds">"</span></span>
                <span class="pl-e">android</span><span class="pl-e">:</span><span class="pl-e">textIsSelectable</span>=<span class="pl-s"><span class="pl-pds">"</span>true<span class="pl-pds">"</span></span>/&gt;
        &lt;/<span class="pl-ent">LinearLayout</span>&gt;
    &lt;/<span class="pl-ent">FrameLayout</span>&gt;
&lt;/<span class="pl-ent">layout</span>&gt;</pre></div>

<p>We can see the different views we are going to play with (the <em>LCE</em>). And we can see the DataBinding in action to bind views to the model we defined.</p>

<p>Thanks to the MVP architecture we set, we gain a lot when structuring our code:</p>

<ul>
<li>a dedicated class to load and present the suitable widgets: the <em>Presenter</em>
</li>
<li>a class to represent the data we should display: the <em>Model</em>
</li>
<li>a tuple &lt;<code>Fragment</code>, layout&gt; to represent the way we display data: the <em>View</em>
</li>
</ul>

<p>With this well-structured and decoupled approach, it's easy to add a new screen, organize its code and maintain the project. Moreover, the presenter (where all the business logic takes place) can be easily unit tested by mocking the <em>View</em> part.</p>

<h2>
<a id="write-thinner-classes" class="anchor" href="#write-thinner-classes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Write thinner classes</h2>

<p>Having in mind the huge number of <em>listener</em>, boilerplate code to display specific views and content, handling user interaction (button click, text changes, menu item click)... and so on, it's usual to write <code>Activity</code>/<code>Fragment</code> with a huge number of lines, methods and interfaces. It could become very difficult to read (so to understand and maintain) theses files.</p>

<p>This section aims at writing this code in a different way:</p>

<ul>
<li>is it possible to reorganize in meaningful layers?</li>
<li>is it possible to get rid of boilerplate code and automate its generation?</li>
</ul>

<p>I'm going to give some ideas to answer these questions.</p>

<h3>
<a id="benefits-of-java-annotations-and-annotation-processing-tool-apt" class="anchor" href="#benefits-of-java-annotations-and-annotation-processing-tool-apt" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Benefits of Java annotations and Annotation Processing Tool (APT)</h3>

<p>A major step forward in Android development was the release of the <a href="https://bitbucket.org/hvisser/android-apt"><code>android-apt</code></a> project, by Hugo Visser.</p>

<p>It allows developer to configure, in the gradle build, the compile-time annotation processing. Most of times, libraries using it generates the boilerplate code developer should not have to write.</p>

<p>Let's have a look to some libraries using Java annotations to drastically simplify Android development, and sometimes built upon <code>android-apt</code>.</p>

<h4>
<a id="butter-knife" class="anchor" href="#butter-knife" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Butter Knife</h4>

<ul>
<li><a href="http://jakewharton.github.io/butterknife/">http://jakewharton.github.io/butterknife/</a></li>
</ul>

<p>A definitely "must-have library", quoted in every listing!</p>

<p>It has annotations processor to bind a lot of resources considerations to Java code:</p>

<ul>
<li>bind a view by its ID to a Java <code>View</code> object, idem for a list of views</li>
<li>bind string resource by its ID to a Java <code>String</code> object, idem for drawables, colors, dimensions and so on</li>
<li>listen to the click of a view (or a list of views) by its ID and call a specific method</li>
<li>listen to item selection in a <code>ListView</code>
</li>
<li>listen to some events on views like <code>OnCheckedChanged</code>, <code>OnEditorAction</code>, <code>OnFocusChange</code> ,<code>OnTextChanged</code>, etc.</li>
</ul>

<p>A huge advantage I see is that: when you add a new widget in your layout, using the "native" way, you should</p>

<ul>
<li>define the associated field in your Java class</li>
<li>call the <code>findViewById</code> method</li>
<li>cast the result</li>
</ul>

<p>Now, with Butter Knife, simply define the associated field and annotate it. The <code>ButterKnife.bind</code> will replace the two next steps. So, you add a widget faster!</p>

<p>Using it with <a href="https://github.com/avast/android-butterknife-zelezny">its Android Studio plugin</a>, and you go even faster! Nothing to add!</p>

<h4>
<a id="fragmentargs" class="anchor" href="#fragmentargs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FragmentArgs</h4>

<p>When the <em>Fragments</em> API released, this article was my guidelines: <a href="http://android-developers.blogspot.fr/2011/02/android-30-fragments-api.html">The Android 3.0 Fragments API</a>.</p>

<p>But, the more I created fragments, the more a question grew in my mind:</p>

<blockquote>
<p>Is there a way to get rid of the static <code>newInstance</code> I spend so much time to write?</p>
</blockquote>

<p>Well OK, not so much in fact, but I found it so painful to rewrite each time a add a new fragment. That's why I looked for a way to automate it. And here comes FragmentArgs!</p>

<ul>
<li><a href="http://hannesdorfmann.com/android/fragmentargs/">http://hannesdorfmann.com/android/fragmentargs/</a></li>
<li><a href="https://github.com/sockeqwe/fragmentargs">https://github.com/sockeqwe/fragmentargs</a></li>
</ul>

<p>It provides simple annotations to set up to your fragment, and the annotation processor generates you the builder class that corresponds. By using the word "builder", the hint is that you can specify that some parameters are optional.</p>

<p>That way, you gain a formal contract to create your fragment, you are of which parameters to provide and you reduce risks to badly configure this one.</p>

<h4>
<a id="intentbuilder" class="anchor" href="#intentbuilder" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>IntentBuilder</h4>

<ul>
<li><a href="https://github.com/emilsjolander/IntentBuilder">https://github.com/emilsjolander/IntentBuilder</a></li>
</ul>

<p>After using FragmentArgs, I asked myself how to start activities and services in the same way. My motivations are pretty the same that for FragmentArgs. The collateral benefit is that I gain a similar way to build all these concepts from the Android SDK.</p>

<p>Having this in mind, IntentBuilder represent the perfect solution I was looking for.</p>

<h4>
<a id="icepick" class="anchor" href="#icepick" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Icepick</h4>

<ul>
<li><a href="https://github.com/frankiesardo/icepick">https://github.com/frankiesardo/icepick</a></li>
</ul>

<p>Another "must-have library", quoted frequently in listings!</p>

<p>It aims at simplify the way to save and restore the state of activities and fragments.
It provides very clear annotations and a powerful util class named <code>Icepick</code>.</p>

<h4>
<a id="onactivityresult" class="anchor" href="#onactivityresult" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>OnActivityResult</h4>

<ul>
<li><a href="https://github.com/vanniktech/OnActivityResult">https://github.com/vanniktech/OnActivityResult</a></li>
</ul>

<p>Another boilerplate code often written by an Android developer concerns the "OnActivityResult" part.</p>

<p>We have to override the <code>onActivityResult</code> method, test the request code, test the result code, and here we can deal with result. We usually fall in a lot of nested blocks, difficult to read and understand.</p>

<p>This library provides a relevant answer to this issue.</p>

<p>With the simple <code>@OnActivityResult</code> annotation and its parameters, placed up above a method declaration, we can clearly specify the method to call in which case of activity result.</p>

<p>The code is definitely lighter and clearer.</p>

<h4>
<a id="project-lombok" class="anchor" href="#project-lombok" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Project Lombok</h4>

<ul>
<li><a href="https://projectlombok.org/">https://projectlombok.org/</a></li>
</ul>

<p>It's a famous Java project to reduce boilerplate Java code.
Developer writes less code, to it's less error-prone and easy to read (so to maintain).</p>

<p>In an Android project, using Android Studio, it should be used in combination with the associated plugin:</p>

<ul>
<li><a href="https://plugins.jetbrains.com/plugin/6317">https://plugins.jetbrains.com/plugin/6317</a></li>
</ul>

<h3>
<a id="a-new-way-to-set-up-listviewrecyclerview-smart-adapters" class="anchor" href="#a-new-way-to-set-up-listviewrecyclerview-smart-adapters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A new way to set up <code>ListView</code>/<code>RecyclerView</code>: Smart Adapters</h3>

<ul>
<li>Smart Adapters: 

<ul>
<li><a href="https://github.com/mrmans0n/smart-adapters">https://github.com/mrmans0n/smart-adapters</a></li>
</ul>
</li>
</ul>

<p>The advantages I see:</p>

<ul>
<li>No need to write the redundant code of an adapter with its <code>getCount</code> methods and so on</li>
<li>A dedicated class to manage the view to display, that has more meaning that adapter one for me</li>
<li>No more hand-handling of the <em>ViewHolder</em> pattern</li>
<li>An easy binding in few lines in the worker class</li>
<li>Works well with Butter Knife</li>
<li>A fully-customizable listener engine</li>
<li>A powerful way to custom binding of a given <em>Model</em> class to many <em>View</em> class, delegating responsibility to choose right <em>View</em> to a dedicated <em>Builder</em> class</li>
</ul>

<p>The drawbacks I see:</p>

<ul>
<li>Currently not working with <code>Cursor</code>
</li>
</ul>

<h4>
<a id="an-alternative-generics-cursor-michelangelo-and-microorm" class="anchor" href="#an-alternative-generics-cursor-michelangelo-and-microorm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>An alternative: generics, <code>Cursor</code>, Michelangelo and MicroOrm</h4>

<p>It's possible to write a generic <code>Adapter</code> class in the same way it's presented in this repository:</p>

<ul>
<li><a href="https://github.com/blacroix/viewholder_customview_generic/tree/master/app/src/main/java/fr/blacroix/generic">https://github.com/blacroix/viewholder_customview_generic/tree/master/app/src/main/java/fr/blacroix/generic</a></li>
</ul>

<p>It's pretty easy to turn it so that it can manage a <code>Cursor</code>.</p>

<p>Here comes a powerful library to inflate and bind <code>View</code>: <a href="https://github.com/RomainPiel/Michelangelo">Michelangelo</a>.</p>

<p>Now, an easy way to retrieve values from a <code>Cursor</code> could be to use the <a href="https://github.com/chalup/microorm">MicroOrm library</a> (as you can see in a previous section).</p>

<h3>
<a id="welcome-to-a-lambda-expressions-world-from-java-8-thanks-to-retrolambda" class="anchor" href="#welcome-to-a-lambda-expressions-world-from-java-8-thanks-to-retrolambda" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Welcome to a Lambda Expressions world from Java 8 thanks to <code>Retrolambda</code>
</h3>

<p>A major contribution of Java 8 is the lambda expressions.</p>

<p>It's like the <em>closures</em> of languages such as Groovy or Scala for example. The idea is to provide a references mechanism to anonymous code blocks.</p>

<p>In functional languages, this feature is very useful. For example, it allows developers to pass a function "B" as a parameter of a function "A", making this "A" function reusable and easy to test. </p>

<p>To do so similar technique in Java, we often have to declare an interface "B" and provide an anonymous implementation to the function "A". Quite verbose (and boring)!</p>

<p>Lambda expressions provide an attractive since it simplifies the use of interfaces with a single abstract method (i.e., "SAM interfaces" or "Functional Interfaces"), such as <code>Runnable</code>, <code>Comparator</code> and multiple <em>listeners</em> in the Android SDK.</p>

<p>It has a very fluent syntax:</p>

<div class="highlight highlight-source-java"><pre>(parameters) <span class="pl-k">-</span><span class="pl-k">&gt;</span> simple statement

<span class="pl-c">// or</span>

(parameters) <span class="pl-k">-</span><span class="pl-k">&gt;</span> { statements block }</pre></div>

<p>In my Android projects, I use it to significantly reduce the size of my source code. Each time I have to deal with a SAM interface, I can use a lambda expression. By the way, it's frequently Android Studio that advises me to replace my code with a lambda expression!</p>

<p>To do so, I have to include <a href="https://github.com/evant/gradle-retrolambda">Gradle Retrolambda Plugin</a> to my project.</p>

<p>Here is a snippet of me <code>build.gradle</code> file:</p>

<div class="highlight highlight-source-groovy"><pre>buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        <span class="pl-c">// ...</span>
        classpath <span class="pl-s"><span class="pl-pds">'</span>me.tatarka:gradle-retrolambda:3.2.5<span class="pl-pds">'</span></span>
    }
}

repositories {
  mavenCentral()
}

<span class="pl-c">// ...</span>
apply <span class="pl-c1">plugin</span>: <span class="pl-s"><span class="pl-pds">'</span>me.tatarka.retrolambda<span class="pl-pds">'</span></span>

android {

    <span class="pl-c">// ...</span>

    compileOptions {
        sourceCompatibility <span class="pl-k">JavaVersion</span><span class="pl-k">.</span><span class="pl-c1">VERSION_1_8</span>
        targetCompatibility <span class="pl-k">JavaVersion</span><span class="pl-k">.</span><span class="pl-c1">VERSION_1_8</span>
    }
}

retrolambda {
    jvmArgs <span class="pl-s"><span class="pl-pds">'</span>-noverify<span class="pl-pds">'</span></span>
}</pre></div>

<p>And here we are!</p>

<h3>
<a id="simplify-the-logic-to-switch-between-lce-views" class="anchor" href="#simplify-the-logic-to-switch-between-lce-views" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Simplify the logic to switch between <em>LCE</em> views</h3>

<p>LCE is an acronym (I knew thanks to the Mosby articles) to describe the traditional Loading-Content-Error views an <code>Activity</code> or <code>Fragment</code> could manage. I just would like to add the <em>Empty</em> view notion.</p>

<p>It's a common task to switch from one <code>View</code> to another according to user interaction and/or jobs execution. It could easily become a complex lot of methods with boolean parameters to represent the view state. Not easy to set up and not easy to read when coming back to the project few months later.</p>

<p>I looked for various approaches to simplify this (error-prone) task.
And a relevant answer I found is the use of the Switcher library.</p>

<ul>
<li><a href="https://github.com/jkwiecien/Switcher">https://github.com/jkwiecien/Switcher</a></li>
</ul>

<p>It's very simple to set up. Just declare your widgets in layouts, as usual.
And in your activity or fragment class, you build a new instance of <code>Switcher</code>.
You set up the various views it has to play with:</p>

<div class="highlight highlight-source-java"><pre>switcher <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Switcher</span>.<span class="pl-smi">Builder</span>(<span class="pl-v">this</span>)
                .addContentView(findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>recycler_view)) <span class="pl-c">// content member</span>
                .addErrorView(findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>error_view)) <span class="pl-c">// error view member</span>
                .addProgressView(findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>progress_view)) <span class="pl-c">// progress view member</span>
                .setErrorLabel((<span class="pl-smi">TextView</span>) findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>error_label)) <span class="pl-c">// error label</span>
                .addEmptyView(findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>empty_view)) <span class="pl-c">// empty placeholder member</span>
                .build();</pre></div>

<p>And then you just have to call the suitable method when needed:</p>

<div class="highlight highlight-source-java"><pre>switcher<span class="pl-k">.</span>showContentView();
switcher<span class="pl-k">.</span>showProgressView();
switcher<span class="pl-k">.</span>showErrorView();
switcher<span class="pl-k">.</span>showEmptyView();</pre></div>

<p>And here you gain a fluent way to play with your views visibility and have a consistent view state machine.</p>

<h2>
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Testing</h2>

<p>The first step to write unit tests on Android is to set up our <code>build.gradle</code> file to be able to use JUnit and its <code>AndroidJUnitRunner</code> and write JUnit 4.x tests.</p>

<p>To do so, we follow the documentation from the <a href="https://google.github.io/android-testing-support-library">Android Testing Support Library</a></p>

<p>So our <code>build.gradle</code> looks like:</p>

<div class="highlight highlight-source-groovy"><pre>android {
    <span class="pl-c">// ...</span>

    defaultConfig {
        <span class="pl-c">// ...</span>

        testInstrumentationRunner <span class="pl-s"><span class="pl-pds">"</span>android.support.test.runner.AndroidJUnitRunner<span class="pl-pds">"</span></span>
    }
    <span class="pl-c">// ...</span>
}

dependencies {
    androidTestCompile <span class="pl-s"><span class="pl-pds">'</span>com.android.support:support-annotations:23.1.1<span class="pl-pds">'</span></span>
    androidTestCompile <span class="pl-s"><span class="pl-pds">'</span>com.android.support.test:runner:0.4.1<span class="pl-pds">'</span></span>
    androidTestCompile <span class="pl-s"><span class="pl-pds">'</span>com.android.support.test:rules:0.4.1<span class="pl-pds">'</span></span>
}</pre></div>

<p>The <code>support-annotations</code> allows us to use JUnit specific annotations to configure the test run.</p>

<p>This way, we can define JUnit 4.x tests like:</p>

<div class="highlight highlight-source-java"><pre>@RunWith(<span class="pl-smi">AndroidJUnit4</span><span class="pl-k">.</span>class)
@<span class="pl-smi">LargeTest</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TestClass</span> {

    <span class="pl-c">//region Test lifecycle</span>
    <span class="pl-k">@Before</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() {
    }

    <span class="pl-k">@After</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">tearDown</span>() {
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Test methods</span>
    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">testMethod</span>() {
        <span class="pl-c">// TODO write test</span>
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<h3>
<a id="write-tests-the-bdd-way" class="anchor" href="#write-tests-the-bdd-way" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Write tests the BDD way</h3>

<p>A trend I love when writing tests is to use the "given/when/then" canvas. The result is an organized writing of test methods, following a specific requirement, that can serve as technical documentation.</p>

<p>That's why I wonder "how to write better unit tests for my Android projects?".</p>

<p>I first answer I found were to use Java labels such as:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">void</span> test_A_Test_Method() throws <span class="pl-smi">IOException</span> {
    <span class="pl-smi">Given</span><span class="pl-k">:</span>
    {
        <span class="pl-c">// 'given' statements</span>
    }

    <span class="pl-smi">When</span><span class="pl-k">:</span>
    {
        <span class="pl-c">// 'when' statements</span>
    }

    <span class="pl-smi">Then</span><span class="pl-k">:</span>
    {
        <span class="pl-c">// 'then' statements</span>
    }
}</pre></div>

<p>Nothing special, except the structure of the tree steps of this canvas to three "blocks" of Java code, prefixed with specific labels.</p>

<p>Another tool I came with is the very attractive <a href="https://github.com/ignaciotcrespo/frutilla">Frutilla</a>.</p>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_frutilla.jpg" alt="Frutilla logo"></p>

<p>The idea is to describe the tests in plain text thanks to Java annotations, as follows:</p>

<div class="highlight highlight-source-java"><pre>@RunWith(value <span class="pl-k">=</span> <span class="pl-smi">org.frutilla<span class="pl-k">.</span>FrutillaTestRunner</span><span class="pl-k">.</span>class)
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FrutillaExamplesWithAnnotationTest</span> {

    <span class="pl-k">@Frutilla</span>(
        <span class="pl-c1">Given</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>a test with Frutilla annotations<span class="pl-pds">"</span></span>,
        <span class="pl-c1">When</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>it fails due to an error<span class="pl-pds">"</span></span>,
        <span class="pl-c1">Then</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>it shows the test description in the stacktrace<span class="pl-pds">"</span></span>
    )
    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">testError</span>() {
        <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-smi">RuntimeException</span>(<span class="pl-s"><span class="pl-pds">"</span>forced error<span class="pl-pds">"</span></span>);
    }

}</pre></div>

<p>The first benefit is that the test method explains itself it specific use case.
Next, when a test fails, the stacktrace becomes very clear and describes precisely the failing use case.</p>

<h3>
<a id="fluent-assertions" class="anchor" href="#fluent-assertions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fluent assertions</h3>

<p>To make it easier to write tests, I like to use third-party libraries that provide fluent API, such as:</p>

<ul>
<li>Truth: <a href="http://google.github.io/truth/">http://google.github.io/truth/</a>
</li>
<li>AssertJ: <a href="http://joel-costigliola.github.io/assertj/assertj-core.html">http://joel-costigliola.github.io/assertj/assertj-core.html</a>
</li>
</ul>

<p>Where developers formerly wrote:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">import static</span> <span class="pl-smi">org.junit.Assert.assertTrue</span>;

<span class="pl-k">Set&lt;<span class="pl-smi">Foo</span>&gt;</span> foo <span class="pl-k">=</span> <span class="pl-c1">...</span>;
assertTrue(foo<span class="pl-k">.</span>isEmpty());</pre></div>

<p>then now can write:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">import static</span> <span class="pl-smi">com.google.common.truth.Truth.assertThat</span>;

<span class="pl-k">Set&lt;<span class="pl-smi">Foo</span>&gt;</span> foo <span class="pl-k">=</span> <span class="pl-c1">...</span>;
assertThat(foo)<span class="pl-k">.</span>isEmpty();</pre></div>

<p>The first advantage is that it makes tests easier to read. Another one is that the failure messages are more meaningful.</p>

<p>Square also released a library to write assertions specific to Android views:</p>

<ul>
<li>AssertJ Android:  <a href="http://square.github.io/assertj-android/">http://square.github.io/assertj-android/</a>
</li>
</ul>

<h3>
<a id="mocking" class="anchor" href="#mocking" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mocking</h3>

<p>To mock the behavior of some component of my projects, I use the <a href="http://site.mockito.org">Mockito library</a>.</p>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_mockito.png" alt="Mockito logo"></p>

<p>Considering I'm in Multidex project, I had to configure my <code>build.gradle</code> as follows:</p>

<div class="highlight highlight-source-groovy"><pre>    androidTestCompile <span class="pl-s"><span class="pl-pds">'</span>org.mockito:mockito-core:1.10.19<span class="pl-pds">'</span></span>
    androidTestCompile <span class="pl-s"><span class="pl-pds">'</span>com.google.dexmaker:dexmaker-mockito:1.2<span class="pl-pds">'</span></span></pre></div>

<p>For example, I wanted to mock my <em>image loader</em> component (in this case, I use <a href="http://square.github.io/picasso/">Picasso</a>). So I mocked this component and its Dagger2 module as follows:</p>

<div class="highlight highlight-source-java"><pre>    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">Picasso</span> mPicasso <span class="pl-k">=</span> mock(<span class="pl-smi">Picasso</span><span class="pl-k">.</span>class);
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">PicassoModule</span> mPicassoModule <span class="pl-k">=</span> mock(<span class="pl-smi">PicassoModule</span><span class="pl-k">.</span>class);

    <span class="pl-k">public</span> <span class="pl-smi">Picasso</span> getPicasso() {
        <span class="pl-k">return</span> mPicasso;
    }</pre></div>

<p>So when starting we UI tests, this code allows me to mock the behavior of Picasso. Afterwards I can assert the calls that were made to this component, thanks to Mockito's API:</p>

<div class="highlight highlight-source-java"><pre>verify(mModuleRest<span class="pl-k">.</span>getPicasso(), times(<span class="pl-c1">2</span>))<span class="pl-k">.</span>load(<span class="pl-s"><span class="pl-pds">"</span>a test url<span class="pl-pds">"</span></span>);</pre></div>

<p>Other well-known mocking libraries are commonly used across the Android ecosystem. Just to quote them:</p>

<ul>
<li>Robolectric: <a href="http://robolectric.org/">http://robolectric.org/</a>
</li>
</ul>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_robolectric.png" alt="Robolectric logo"></p>

<ul>
<li>PowerMock: <a href="https://github.com/jayway/powermock">https://github.com/jayway/powermock</a>
</li>
</ul>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_powermock.png" alt="PowerMock logo"></p>

<h3>
<a id="ui-testing" class="anchor" href="#ui-testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>UI testing</h3>

<p>Another well-known testing library is <a href="https://github.com/robotiumtech/robotium">Robotium</a>. It's a powerful to describe and run UI tests.</p>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_robotium.png" alt="Robotium logo"></p>

<p>To set it up, we have to use it in combination with the <a href="http://developer.android.com/reference/android/support/test/rule/ActivityTestRule.html"><code>ActivityTestRule</code></a>. This one allows us to write tests concerning an Android <code>Activity</code>. Then we get this <code>Activity</code>to configure our <code>Solo</code> instance. This <code>Solo</code> class is the entry point of the Robotium tool. This class provides a wide set of methods to reproduce the user behavior.</p>

<p>To make it easier to write Robotium test cases, I wrote an abstract and generic test class:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">AbstractRobotiumTestCase</span>&lt;TypeActivity <span class="pl-k">extends</span> <span class="pl-e">Activity</span>&gt; {
    <span class="pl-c">//region Rule</span>
    <span class="pl-k">@Rule</span>
    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-k">ActivityTestRule&lt;<span class="pl-smi">TypeActivity</span>&gt;</span> mActivityTestRule;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Fields</span>
    <span class="pl-k">protected</span> <span class="pl-smi">Solo</span> mSolo;
    <span class="pl-k">protected</span> <span class="pl-smi">TypeActivity</span> mActivity;
    <span class="pl-k">protected</span> <span class="pl-smi">Context</span> mContextTest;
    <span class="pl-k">protected</span> <span class="pl-smi">Context</span> mContextTarget;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Constructor</span>
    <span class="pl-k">protected</span> <span class="pl-en">AbstractRobotiumTestCase</span>(<span class="pl-k">final</span> <span class="pl-k">ActivityTestRule&lt;<span class="pl-smi">TypeActivity</span>&gt;</span> <span class="pl-v">poActivityTestRule</span>) {
        mActivityTestRule <span class="pl-k">=</span> poActivityTestRule;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Test lifecycle</span>
    <span class="pl-k">@Before</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        mActivity <span class="pl-k">=</span> mActivityTestRule<span class="pl-k">.</span>getActivity();
        mSolo <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Solo</span>(<span class="pl-smi">InstrumentationRegistry</span><span class="pl-k">.</span>getInstrumentation(), mActivity);
        mContextTest <span class="pl-k">=</span> <span class="pl-smi">InstrumentationRegistry</span><span class="pl-k">.</span>getContext();
        mContextTarget <span class="pl-k">=</span> <span class="pl-smi">InstrumentationRegistry</span><span class="pl-k">.</span>getTargetContext();
    }

    <span class="pl-k">@After</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">tearDown</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        mSolo<span class="pl-k">.</span>finishOpenedActivities();
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>So now, to add a new test case for a specific <code>Activity</code>, I just have to subclass this <code>AbstractRobotiumTestCase</code> as follows:</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">LargeTest</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TestMyCustomActivity</span> <span class="pl-k">extends</span> <span class="pl-e">AbstractRobotiumTestCase&lt;<span class="pl-smi">MyCustomActivity</span>&gt;</span> {

    <span class="pl-c">//region Constructor matching super</span>
    <span class="pl-k">public</span> <span class="pl-en">TestMyCustomActivity</span>() {
        <span class="pl-v">super</span>(<span class="pl-k">new</span> <span class="pl-k">ActivityTestRule&lt;&gt;</span>(<span class="pl-smi">MyCustomActivity</span><span class="pl-k">.</span>class, <span class="pl-c1">true</span>, <span class="pl-c1">false</span>));
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Test lifecycle</span>
    <span class="pl-k">@Before</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-v">super</span><span class="pl-k">.</span>setUp();

        <span class="pl-c">// set up statements</span>
    }

    <span class="pl-k">@After</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">tearDown</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-v">super</span><span class="pl-k">.</span>tearDown();

        <span class="pl-c">// tear down statements</span>

        <span class="pl-k">if</span>(mActivity <span class="pl-k">!=</span> <span class="pl-c1">null</span>) {
            mActivity<span class="pl-k">.</span>finish();
        }
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Test methods</span>
    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">test_A_Test_Method</span>() {
        <span class="pl-smi">Given</span><span class="pl-k">:</span>
        {
            <span class="pl-c">// 'given' statements</span>
            mActivity <span class="pl-k">=</span> mActivityTestRule<span class="pl-k">.</span>launchActivity(<span class="pl-c1">null</span>);
        }

        <span class="pl-smi">When</span><span class="pl-k">:</span>
        {
            <span class="pl-c">// 'when' statements</span>
        }

        <span class="pl-smi">Then</span><span class="pl-k">:</span>
        {
            <span class="pl-c">// 'then' statements</span>
        }
    }
}</pre></div>

<p>I pass <code>false</code> as third parameter to the <code>ActivityTestRule</code> constructor so it don't start the activity by default. Then, I launch the activity at the end of my "given" block, after all initializations I need.
By calling <code>mActivityTestRule.launchActivity(null)</code>, I notify the test rule to build the default <code>Intent</code> (thanks to the <code>null</code> parameter) and start it. It returns me an instance of the started activity.</p>

<h3>
<a id="combination-with-dependency-injection" class="anchor" href="#combination-with-dependency-injection" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Combination with dependency injection</h3>

<p>A point of interest for us is to turn off some features and replace them with mocks when running our tests. Thanks to Dagger2, it becomes easy to do so.</p>

<p>First, let's have a look to my <code>Application</code> subclass:</p>

<div class="highlight highlight-source-java"><pre>@AutoComponent(
        modules <span class="pl-k">=</span> {
                <span class="pl-smi">ModuleAsync</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleBus</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleContext</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleDatabase</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleEnvironment</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleRest</span><span class="pl-k">.</span>class,
                <span class="pl-smi">ModuleTransformer</span><span class="pl-k">.</span>class
        }
)
@<span class="pl-smi">Singleton</span>
@AutoInjector(<span class="pl-smi">ApplicationAndroidStarter</span><span class="pl-k">.</span>class)
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ApplicationAndroidStarter</span> <span class="pl-k">extends</span> <span class="pl-e">Application</span> {
    <span class="pl-c">//region Singleton</span>
    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">ApplicationAndroidStarter</span> sSharedApplication;

    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-smi">ApplicationAndroidStarter</span> <span class="pl-en">sharedApplication</span>() {
        <span class="pl-k">return</span> sSharedApplication;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Component</span>
    <span class="pl-k">protected</span> <span class="pl-smi">ApplicationAndroidStarterComponent</span> mComponentApplication;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">// ...</span>

    <span class="pl-c">//region Overridden methods</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate();
        sSharedApplication <span class="pl-k">=</span> <span class="pl-v">this</span>;

        buildComponent();

        <span class="pl-c">// ...</span>
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onTerminate</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onTerminate();
        sSharedApplication <span class="pl-k">=</span> <span class="pl-c1">null</span>;
        <span class="pl-c">// ...</span>
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Getters</span>
    <span class="pl-k">public</span> <span class="pl-smi">ApplicationAndroidStarterComponent</span> <span class="pl-en">componentApplication</span>() {
        <span class="pl-k">return</span> mComponentApplication;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Protected methods</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">buildComponent</span>() {
        mComponentApplication <span class="pl-k">=</span> <span class="pl-smi">DaggerApplicationAndroidStarterComponent</span><span class="pl-k">.</span>builder()
                .moduleAsync(<span class="pl-k">new</span> <span class="pl-smi">ModuleAsync</span>())
                .moduleBus(<span class="pl-k">new</span> <span class="pl-smi">ModuleBus</span>())
                .moduleContext(<span class="pl-k">new</span> <span class="pl-smi">ModuleContext</span>(getApplicationContext()))
                .moduleDatabase(<span class="pl-k">new</span> <span class="pl-smi">ModuleDatabase</span>())
                .moduleEnvironment(<span class="pl-k">new</span> <span class="pl-smi">ModuleEnvironment</span>())
                .moduleRest(<span class="pl-k">new</span> <span class="pl-smi">ModuleRest</span>())
                .moduleTransformer(<span class="pl-k">new</span> <span class="pl-smi">ModuleTransformer</span>())
                .build();
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>It's the entry point where every element asks for its dependencies. Now, the idea is to subclass it in my test project, as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MockApplication</span> <span class="pl-k">extends</span> <span class="pl-e">ApplicationAndroidStarter</span> {

    <span class="pl-c">//region Fields</span>
    <span class="pl-k">private</span> <span class="pl-smi">ModuleBus</span> mModuleBus;
    <span class="pl-k">private</span> <span class="pl-smi">MockModuleRest</span> mModuleRest;
    <span class="pl-k">private</span> <span class="pl-smi">ModuleEnvironment</span> mModuleEnvironment;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Singleton</span>
    <span class="pl-k">protected</span> <span class="pl-k">static</span> <span class="pl-smi">MockApplication</span> sSharedMockApplication;

    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-smi">MockApplication</span> <span class="pl-en">sharedMockApplication</span>() {
        <span class="pl-k">return</span> sSharedMockApplication;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Lifecycle</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate();
        sSharedMockApplication <span class="pl-k">=</span> <span class="pl-v">this</span>;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Overridden method</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">buildComponent</span>() {
        mModuleBus <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ModuleBus</span>();
        mModuleRest <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MockModuleRest</span>();
        mModuleEnvironment <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MockModuleEnvironment</span>();

        mComponentApplication <span class="pl-k">=</span> <span class="pl-smi">DaggerApplicationAndroidStarterComponent</span><span class="pl-k">.</span>builder()
                .moduleAsync(<span class="pl-k">new</span> <span class="pl-smi">ModuleAsync</span>())
                .moduleBus(mModuleBus)
                .moduleContext(<span class="pl-k">new</span> <span class="pl-smi">ModuleContext</span>(getApplicationContext()))
                .moduleDatabase(<span class="pl-k">new</span> <span class="pl-smi">MockModuleDatabase</span>())
                .moduleEnvironment(mModuleEnvironment)
                .moduleRest(mModuleRest)
                .moduleTransformer(<span class="pl-k">new</span> <span class="pl-smi">ModuleTransformer</span>())
                .build();
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Getters</span>
    <span class="pl-k">public</span> <span class="pl-smi">MockModuleRest</span> <span class="pl-en">getModuleRest</span>() {
        <span class="pl-k">return</span> mModuleRest;
    }

    <span class="pl-k">public</span> <span class="pl-smi">ModuleBus</span> <span class="pl-en">getModuleBus</span>() {
        <span class="pl-k">return</span> mModuleBus;
    }

    <span class="pl-k">public</span> <span class="pl-smi">ModuleEnvironment</span> <span class="pl-en">getModuleEnvironment</span>() {
        <span class="pl-k">return</span> mModuleEnvironment;
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>Here I need to mock my <code>ModuleRest</code> for example. I can do so thanks to the following code:</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Module</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MockModuleRest</span> <span class="pl-k">extends</span> <span class="pl-e">ModuleRest</span> {
    <span class="pl-c">//region Fields</span>
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">MockWebServer</span> mMockWebServer;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Constructor</span>
    <span class="pl-k">public</span> <span class="pl-en">MockModuleRest</span>() {
        mMockWebServer <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MockWebServer</span>();
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Modules</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">GitHubService</span> <span class="pl-en">provideGithubService</span>(<span class="pl-k">@NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">OkHttpClient</span> <span class="pl-v">poOkHttpClient</span>) {
        <span class="pl-k">final</span> <span class="pl-smi">Retrofit</span> loRetrofit <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Retrofit</span>.<span class="pl-smi">Builder</span>()
                .baseUrl(mMockWebServer<span class="pl-k">.</span>url(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>toString())
                .addConverterFactory(<span class="pl-smi">JacksonConverterFactory</span><span class="pl-k">.</span>create())
                .build();
        <span class="pl-k">return</span> loRetrofit<span class="pl-k">.</span>create(<span class="pl-smi">GitHubService</span><span class="pl-k">.</span>class);
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Getters</span>
    <span class="pl-k">public</span> <span class="pl-smi">MockWebServer</span> <span class="pl-en">getMockWebServer</span>() {
        <span class="pl-k">return</span> mMockWebServer;
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Visible API</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() {
        mMockWebServer <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MockWebServer</span>();
    }
    <span class="pl-c">//endregion</span>
}</pre></div>

<p>I lean on <a href="https://github.com/square/okhttp/tree/master/mockwebserver">MockWebServer</a> to enqueue mock responses. This way, each time a REST call is made, it will deal with mock responses I declared.</p>

<p>The next point is: to use this mock application, we should configure our test project. It begins with the creation of a custom <code>AndroidJUnitRunner</code> to declare the <code>Application</code> subclass to use:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">AndroidStarterTestRunner</span> <span class="pl-k">extends</span> <span class="pl-e">AndroidJUnitRunner</span> {

    <span class="pl-c">//region Overridden method</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>(<span class="pl-k">final</span> <span class="pl-smi">Bundle</span> <span class="pl-v">poArguments</span>) {
        <span class="pl-smi">MultiDex</span><span class="pl-k">.</span>install(<span class="pl-v">this</span><span class="pl-k">.</span>getTargetContext());
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate(poArguments);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Application</span> <span class="pl-en">newApplication</span>(
            <span class="pl-k">final</span> <span class="pl-smi">ClassLoader</span> <span class="pl-v">poClassLoader</span>,
            <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">psClassName</span>,
            <span class="pl-k">final</span> <span class="pl-smi">Context</span> <span class="pl-v">poContext</span>) <span class="pl-k">throws</span> <span class="pl-smi">InstantiationException</span>, <span class="pl-smi">IllegalAccessException</span>, <span class="pl-smi">ClassNotFoundException</span> {
        <span class="pl-k">return</span> <span class="pl-v">super</span><span class="pl-k">.</span>newApplication(poClassLoader, <span class="pl-smi">MockApplication</span><span class="pl-k">.</span>class<span class="pl-k">.</span>getName(), poContext);
    }
    <span class="pl-c">//endregion</span>

}</pre></div>

<p>Now, we simply have to change our <code>build.gradle</code> file to point to his <code>AndroidJUnitRunner</code>:</p>

<div class="highlight highlight-source-groovy"><pre>android {
    <span class="pl-c">// ...</span>

    defaultConfig {
        <span class="pl-c">// ...</span>

        testInstrumentationRunner <span class="pl-s"><span class="pl-pds">"</span>fr.guddy.androidstarter.tests.runner.AndroidStarterTestRunner<span class="pl-pds">"</span></span>
    }</pre></div>

<p>Finally, in our test case, we can enqueue mock responses as follows:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ATestCase</span> {

    <span class="pl-c">//region Fields</span>
    <span class="pl-k">private</span> <span class="pl-smi">MockModuleRest</span> mModuleRest;
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Test lifecycle</span>
    <span class="pl-k">@Before</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-c">// ...</span>

        <span class="pl-c">// get the mock REST module</span>
        mModuleRest <span class="pl-k">=</span> <span class="pl-smi">MockApplication</span><span class="pl-k">.</span>sharedMockApplication()<span class="pl-k">.</span>getModuleRest();
    }

    <span class="pl-k">@After</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">tearDown</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-v">super</span><span class="pl-k">.</span>tearDown();
        <span class="pl-k">try</span> {
            mMockWebServer<span class="pl-k">.</span>shutdown();
        } <span class="pl-k">catch</span> (@<span class="pl-smi">NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Exception</span> loException) {
            loException<span class="pl-k">.</span>printStackTrace();
        }
    }
    <span class="pl-c">//endregion</span>

    <span class="pl-c">//region Test methods</span>
    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">test_A_Test_Method</span>() {
        <span class="pl-smi">Given</span><span class="pl-k">:</span>
        {
            <span class="pl-k">final</span> <span class="pl-smi">String</span> lsSpecificJSONData <span class="pl-k">=</span> <span class="pl-c">/* specific JSON data*/</span>;
            <span class="pl-k">final</span> <span class="pl-smi">MockResponse</span> loMockResponse <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MockResponse</span>()<span class="pl-k">.</span>setResponseCode(<span class="pl-c">/* HTTP status code */</span>);
            loMockResponseWithOneRepo<span class="pl-k">.</span>setBody(lsSpecificJSONData);
            mModuleRest<span class="pl-k">.</span>getMockWebServer()<span class="pl-k">.</span>enqueue(loMockResponse);
            <span class="pl-k">try</span> {
                mMockWebServer<span class="pl-k">.</span>start(<span class="pl-c">/* the mock web server pot */</span>);
            } <span class="pl-k">catch</span> (@<span class="pl-smi">NonNull</span> <span class="pl-k">final</span> <span class="pl-smi">Exception</span> loException) {
                loException<span class="pl-k">.</span>printStackTrace();
            }
            <span class="pl-c">// 'then' statements</span>
        }

        <span class="pl-smi">When</span><span class="pl-k">:</span>
        {
            <span class="pl-c">// 'when' statements</span>
        }

        <span class="pl-smi">Then</span><span class="pl-k">:</span>
        {
            <span class="pl-c">// 'then' statements</span>
        }
    }
}</pre></div>

<p>This example is focused on REST communications, but it can be applied on various layers such as persistence for example.</p>

<p>Moreover, the example shown enqueues only one mock response, but it becomes possible to add multiple responses to build more complex scenarios.</p>

<h2>
<a id="code-coverage" class="anchor" href="#code-coverage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Code coverage</h2>

<p>Android SDK comes with <a href="http://emma.sourceforge.net/">Emma Code Coverage</a>. We can activate the code coverage in the <code>build.gradle</code> file, as follows:</p>

<div class="highlight highlight-source-groovy"><pre>android {
   buildTypes {
      debug {
         testCoverageEnabled <span class="pl-k">=</span> <span class="pl-c1">true</span>
      }
   }
}</pre></div>

<p>Running the <code>gradle tasks</code> command, we can see:</p>

<pre><code>createDebugCoverageReport - Creates test coverage reports for the debug variant.
</code></pre>

<p>So to get the code coverage report, we need to run this Gradle task <code>createDebugCoverageReport</code>:</p>

<pre><code>gradle createDebugCoverageReport
</code></pre>

<p>Now we can find the report in the <code>{main_module}/build/reports/coverage/debug</code> directory. We just need to open the <code>index.html</code> file in a Web browser to view the report.</p>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/code_coverage_report.png" alt="Code coverage screenshot"></p>

<h2>
<a id="relevant-libraries" class="anchor" href="#relevant-libraries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Relevant libraries</h2>

<ul>
<li>
<p>Arrow: </p>

<blockquote>
<p>Arrow is Lightweight library toolbox for Java and Android Development.</p>
</blockquote>

<ul>
<li><a href="https://github.com/android10/arrow">https://github.com/android10/arrow</a></li>
</ul>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_arrow.jpg" alt="Arrow logo"></p>
</li>
<li>
<p>Paperwork</p>

<blockquote>
<p>Generate build info for your Android project without breaking incremental compilation</p>
</blockquote>

<ul>
<li><a href="https://github.com/zsoltk/paperwork">https://github.com/zsoltk/paperwork</a></li>
</ul>
</li>
<li>Logger:

<ul>
<li><a href="https://github.com/orhanobut/logger">https://github.com/orhanobut/logger</a></li>
</ul>
</li>
<li>hugo: 

<ul>
<li><a href="https://github.com/JakeWharton/hugo">https://github.com/JakeWharton/hugo</a></li>
</ul>
</li>
<li>Frodo:
&gt; Android Library for Logging RxJava Observables and Subscribers.

<ul>
<li><a href="https://github.com/android10/frodo">https://github.com/android10/frodo</a></li>
</ul>
</li>
<li>Lynx
&gt; Lynx is an Android library created to show a custom view with all the information Android logcat is printing, different traces of different levels will be rendered to show from log messages to your application exceptions.

<ul>
<li><a href="https://github.com/pedrovgs/Lynx">https://github.com/pedrovgs/Lynx</a></li>
</ul>
</li>
<li>
<p>FluentView</p>

<blockquote>
<p>Android Library for Setting a View via Fluent Interface</p>
</blockquote>

<ul>
<li><a href="https://github.com/nantaphop/FluentView">https://github.com/nantaphop/FluentView</a></li>
</ul>

<p><img src="https://raw.githubusercontent.com/RoRoche/AndroidStarter/master/assets/logo_fluentview.jpeg" alt="FluentView logo"></p>
</li>
</ul>

<h2>
<a id="relevant-tools" class="anchor" href="#relevant-tools" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Relevant tools</h2>

<ul>
<li>
<p>Scalpel</p>

<ul>
<li><a href="https://github.com/JakeWharton/scalpel">https://github.com/JakeWharton/scalpel</a></li>
</ul>

<blockquote>
<p>A surgical debugging tool to uncover the layers under your app.</p>
</blockquote>
</li>
<li>
<p>LeakCanary</p>

<ul>
<li><a href="https://github.com/square/leakcanary">https://github.com/square/leakcanary</a></li>
</ul>

<blockquote>
<p>A memory leak detection library for Android and Java.</p>
</blockquote>
</li>
<li>
<p>DebugDrawer</p>

<ul>
<li><a href="https://github.com/palaima/DebugDrawer">https://github.com/palaima/DebugDrawer</a></li>
</ul>

<blockquote>
<p>Android Debug Drawer for faster development</p>
</blockquote>
</li>
<li>Android Asset Studio

<ul>
<li><a href="http://romannurik.github.io/AndroidAssetStudio/">http://romannurik.github.io/AndroidAssetStudio/</a></li>
</ul>
</li>
<li>Fabric

<ul>
<li><a href="https://fabric.io/">https://fabric.io/</a></li>
<li><a href="https://fabric.io/kits/android/crashlytics/summary">https://fabric.io/kits/android/crashlytics/summary</a></li>
</ul>
</li>
<li>
<p>Vector Asset Studio</p>

<ul>
<li><a href="http://developer.android.com/tools/help/vector-asset-studio.html">http://developer.android.com/tools/help/vector-asset-studio.html</a></li>
</ul>

<blockquote>
<p>Vector Asset Studio helps you add material icons and import Scalable Vector Graphic (SVG) files into your app project as a drawable resource.</p>
</blockquote>
</li>
</ul>

<h2>
<a id="relevant-resources" class="anchor" href="#relevant-resources" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Relevant resources</h2>

<ul>
<li>Android Arsenal

<ul>
<li><a href="http://android-arsenal.com">http://android-arsenal.com</a></li>
</ul>
</li>
<li>androidweekly:

<ul>
<li><a href="http://androidweekly.net/">http://androidweekly.net/</a></li>
</ul>
</li>
<li>Gradle tips &amp; tricks:

<ul>
<li><a href="https://medium.com/@cesarmcferreira/gradle-tips-tricks-to-survive-the-zombie-apocalypse-3dd996604341">https://medium.com/@cesarmcferreira/gradle-tips-tricks-to-survive-the-zombie-apocalypse-3dd996604341</a></li>
</ul>
</li>
<li>RxAndroidLibs

<ul>
<li><a href="https://github.com/zsoltk/RxAndroidLibs">https://github.com/zsoltk/RxAndroidLibs</a></li>
</ul>
</li>
<li>AndroidLibs

<ul>
<li><a href="https://android-libs.com/">https://android-libs.com/</a></li>
</ul>
</li>
</ul>

<h2>
<a id="bibliography" class="anchor" href="#bibliography" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Bibliography</h2>

<ul>
<li>Android DataBinding:

<ul>
<li><a href="http://www.opgenorth.net/blog/2015/09/15/android-data-binding-intro/">http://www.opgenorth.net/blog/2015/09/15/android-data-binding-intro/</a></li>
</ul>
</li>
<li>Code coverage

<ul>
<li><a href="http://blog.wittchen.biz.pl/test-coverage-report-for-android-application/">http://blog.wittchen.biz.pl/test-coverage-report-for-android-application/</a></li>
</ul>
</li>
<li>Dagger2: 

<ul>
<li><a href="http://fernandocejas.com/2015/04/11/tasting-dagger-2-on-android/">http://fernandocejas.com/2015/04/11/tasting-dagger-2-on-android/</a></li>
<li><a href="https://blog.gouline.net/2015/05/04/dagger-2-even-sharper-less-square/">https://blog.gouline.net/2015/05/04/dagger-2-even-sharper-less-square/</a></li>
<li><a href="http://code.tutsplus.com/tutorials/dependency-injection-with-dagger-2-on-android--cms-23345">http://code.tutsplus.com/tutorials/dependency-injection-with-dagger-2-on-android--cms-23345</a></li>
<li><a href="https://www.future-processing.pl/blog/dependency-injection-with-dagger-2/">https://www.future-processing.pl/blog/dependency-injection-with-dagger-2/</a></li>
</ul>
</li>
<li>Retrolambda: 

<ul>
<li><a href="http://www.vogella.com/tutorials/Retrolambda/article.html">http://www.vogella.com/tutorials/Retrolambda/article.html</a></li>
</ul>
</li>
<li>RxJava:

<ul>
<li><a href="http://blog.soat.fr/2015/06/rxjava-ecriture-de-code-asynchrone/">http://blog.soat.fr/2015/06/rxjava-ecriture-de-code-asynchrone/</a></li>
<li><a href="http://blog.xebia.fr/2014/01/10/android-oubliez-definitivement-les-asynctask-avec-rxjava/">http://blog.xebia.fr/2014/01/10/android-oubliez-definitivement-les-asynctask-avec-rxjava/</a></li>
<li><a href="https://github.com/ReactiveX/RxAndroid">https://github.com/ReactiveX/RxAndroid</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/">http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/</a></li>
</ul>
</li>
<li>Testing:

<ul>
<li><a href="https://prezi.com/fxxkpgakbivh/behaviour-driven-development-in-android-studio/">https://prezi.com/fxxkpgakbivh/behaviour-driven-development-in-android-studio/</a></li>
<li><a href="http://fedepaol.github.io/blog/2015/09/05/mocking-with-robolectric-and-dagger-2/">http://fedepaol.github.io/blog/2015/09/05/mocking-with-robolectric-and-dagger-2/</a></li>
</ul>
</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/RoRoche/AndroidStarter">Androidstarter</a> is maintained by <a href="https://github.com/RoRoche">RoRoche</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
